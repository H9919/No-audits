<!-- Enhanced SDS List Template -->
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-file-earmark-text text-success"></i> SDS Library</h3>
    <div>
        <a href="{{ url_for('sds.sds_upload') }}" class="btn btn-primary">
            <i class="bi bi-cloud-upload"></i> Upload SDS
        </a>
        <button class="btn btn-outline-info" onclick="showComparison()">
            <i class="bi bi-files"></i> Compare SDS
        </button>
        <div class="btn-group ms-2" role="group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i> Tools
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="showBulkActions()">
                    <i class="bi bi-check2-square"></i> Bulk Actions
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="showAnalytics()">
                    <i class="bi bi-graph-up"></i> Analytics
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="bulkAIIndex()">
                    <i class="bi bi-cpu"></i> Bulk AI Index
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="exportAll()">
                    <i class="bi bi-download"></i> Export All
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Enhanced Stats Dashboard -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 id="totalSDS">{{ sds_list|length }}</h4>
                <small>Total SDS</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 id="aiIndexedSDS">{{ sds_list|selectattr("has_embeddings", "equalto", true)|list|length }}</h4>
                <small>AI Searchable</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((sds_list|selectattr('has_embeddings', 'equalto', true)|list|length) / (sds_list|length) * 100) if sds_list|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 id="outdatedSDS">0</h4>
                <small>Outdated (>2yr)</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4 id="highHazardSDS">0</h4>
                <small>High Hazard</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 id="departmentsSDS">{{ sds_list|map(attribute="department")|select|unique|list|length }}</h4>
                <small>Departments</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: 75%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h4 id="thisMonthSDS">0</h4>
                <small>Added This Month</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Smart Filters Panel -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-funnel"></i> Smart Filters</h6>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
                <i class="bi bi-x-circle"></i> Clear All
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <!-- Quick Search -->
            <div class="col-md-3">
                <label class="form-label">Quick Search</label>
                <input type="text" class="form-control" id="quickSearch" placeholder="Product, CAS, Chemical...">
            </div>
            
            <!-- Department Filter -->
            <div class="col-md-2">
                <label class="form-label">Department</label>
                <select class="form-select" id="departmentFilter">
                    <option value="">All Departments</option>
                </select>
            </div>
            
            <!-- Country Filter -->
            <div class="col-md-2">
                <label class="form-label">Country</label>
                <select class="form-select" id="countryFilter">
                    <option value="">All Countries</option>
                </select>
            </div>
            
            <!-- Hazard Level Filter -->
            <div class="col-md-2">
                <label class="form-label">Hazard Level</label>
                <select class="form-select" id="hazardFilter">
                    <option value="">All Levels</option>
                    <option value="high">üî¥ High Risk</option>
                    <option value="medium">üü° Medium Risk</option>
                    <option value="low">üü¢ Low Risk</option>
                    <option value="unknown">‚ö™ Unknown</option>
                </select>
            </div>
            
            <!-- AI Index Status -->
            <div class="col-md-2">
                <label class="form-label">AI Status</label>
                <select class="form-select" id="aiStatusFilter">
                    <option value="">All</option>
                    <option value="indexed">ü§ñ AI Searchable</option>
                    <option value="not_indexed">üìÑ Not Indexed</option>
                </select>
            </div>
            
            <!-- Age Filter -->
            <div class="col-md-1">
                <label class="form-label">Age</label>
                <select class="form-select" id="ageFilter">
                    <option value="">All</option>
                    <option value="new">üìÖ New</option>
                    <option value="outdated">‚ö†Ô∏è Old</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced SDS Table -->
<div id="sdsTableContainer">
    <!-- Dynamic table will be rendered here -->
</div>

<!-- SDS Comparison Modal -->
<div class="modal fade" id="comparisonModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-files"></i> SDS Comparison Tool</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Select First SDS</h6>
                        <select class="form-select" id="compareSelect1">
                            <option value="">Choose SDS...</option>
                        </select>
                        <div id="comparePreview1" class="mt-3 p-3 border rounded">
                            <p class="text-muted">Select an SDS to preview</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Select Second SDS</h6>
                        <select class="form-select" id="compareSelect2">
                            <option value="">Choose SDS...</option>
                        </select>
                        <div id="comparePreview2" class="mt-3 p-3 border rounded">
                            <p class="text-muted">Select an SDS to preview</p>
                        </div>
                    </div>
                </div>
                <div class="row mt-4" id="comparisonResults" style="display: none;">
                    <div class="col-12">
                        <h6>Comparison Results</h6>
                        <div id="comparisonTable"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="generateComparisonReport()">
                    <i class="bi bi-file-pdf"></i> Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Label Generation Modal -->
<div class="modal fade" id="labelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-tag"></i> Generate Safety Label</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Label Type</h6>
                        <div class="btn-group w-100 mb-3" role="group">
                            <input type="radio" class="btn-check" name="labelType" id="nfpaType" value="nfpa" checked>
                            <label class="btn btn-outline-primary" for="nfpaType">
                                <i class="bi bi-diamond"></i> NFPA Diamond
                            </label>
                            <input type="radio" class="btn-check" name="labelType" id="ghsType" value="ghs">
                            <label class="btn btn-outline-primary" for="ghsType">
                                <i class="bi bi-exclamation-triangle"></i> GHS Label
                            </label>
                        </div>
                        
                        <div id="sdsSelectForLabel">
                            <label class="form-label">Select SDS</label>
                            <select class="form-select" id="labelSdsSelect">
                                <option value="">Choose SDS...</option>
                            </select>
                        </div>
                        
                        <div class="mt-3" id="labelCustomization">
                            <h6>Customization</h6>
                            <div class="mb-2">
                                <label class="form-label">Label Size</label>
                                <select class="form-select" id="labelSize">
                                    <option value="small">Small (2" x 2")</option>
                                    <option value="medium" selected>Medium (4" x 4")</option>
                                    <option value="large">Large (6" x 6")</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Include QR Code</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeQr" checked>
                                    <label class="form-check-label" for="includeQr">
                                        Add QR code for mobile access
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Preview</h6>
                        <div id="labelPreview" class="border rounded p-3 text-center">
                            <p class="text-muted">Select an SDS to preview label</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="downloadLabel()">
                    <i class="bi bi-download"></i> Download Label
                </button>
                <button type="button" class="btn btn-primary" onclick="printLabel()">
                    <i class="bi bi-printer"></i> Print Label
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Action</label>
                    <select class="form-select" id="bulkActionSelect">
                        <option value="">Choose action...</option>
                        <option value="ai_index">ü§ñ AI Index Selected</option>
                        <option value="set_department">üìç Set Department</option>
                        <option value="generate_qr">üì± Generate QR Codes</option>
                        <option value="export">üìÑ Export Selected</option>
                        <option value="archive">üì¶ Archive Selected</option>
                    </select>
                </div>
                <div id="bulkActionOptions" class="d-none"></div>
                <div class="alert alert-info">
                    <span id="selectedSDSCount">0</span> SDS files selected
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkAction()">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-qr-code"></i> SDS QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer">
                    <!-- QR code will be generated here -->
                </div>
                <div class="mt-3">
                    <p><strong id="qrProductName"></strong></p>
                    <p class="text-muted">Scan to access SDS on mobile device</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadQR()">
                    <i class="bi bi-download"></i> Download QR
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced SDS data with smart processing
    const sdsRawData = {{ sds_list|tojson }};
    const sdsData = enhanceSDSData(sdsRawData);
    
    // Enhanced column configuration with smart features
    const sdsColumns = [
        {
            key: 'id',
            label: 'SDS ID',
            type: 'custom',
            filterable: true,
            sortable: true,
            width: '100px',
            format: (value) => `<code class="small">${value.substring(0, 8)}</code>`
        },
        {
            key: 'product_name',
            label: 'Product Name',
            type: 'custom',
            filterable: true,
            sortable: true,
            width: '250px',
            format: (value, row) => {
                const statusBadges = getStatusBadges(row);
                const truncated = value.length > 35 ? value.substring(0, 35) + '...' : value;
                return `
                    <div class="d-flex flex-column">
                        <strong class="text-truncate" title="${value}">${truncated}</strong>
                        <div class="mt-1">${statusBadges}</div>
                    </div>
                `;
            }
        },
        {
            key: 'department',
            label: 'Department',
            type: 'custom',
            filterable: true,
            sortable: true,
            width: '120px',
            format: (value) => value ? 
                `<span class="badge bg-info text-truncate">${value}</span>` : 
                '<span class="text-muted small">Unassigned</span>'
        },
        {
            key: 'country',
            label: 'Location',
            type: 'custom',
            filterable: true,
            sortable: true,
            width: '140px',
            format: (value, row) => {
                if (!value) return '<span class="text-muted">‚Äî</span>';
                const flag = getCountryFlag(value);
                const state = row.state ? `, ${row.state}` : '';
                return `
                    <div class="small">
                        <div>${flag} ${value}</div>
                        ${state ? `<div class="text-muted">${state}</div>` : ''}
                    </div>
                `;
            }
        },
        {
            key: 'manufacturer',
            label: 'Manufacturer',
            type: 'text',
            filterable: true,
            sortable: true,
            width: '140px',
            format: (value) => {
                if (!value) return '<span class="text-muted">Unknown</span>';
                return value.length > 20 ? 
                    `<span title="${value}">${value.substring(0, 20)}...</span>` : 
                    value;
            }
        },
        {
            key: 'hazard_info',
            label: 'Hazard Level',
            type: 'custom',
            filterable: true,
            sortable: true,
            width: '120px',
            format: (value, row) => {
                const level = getHazardLevel(row);
                const color = getHazardColor(level);
                const icon = getHazardIcon(level);
                return `
                    <span class="badge ${color}" title="Based on H-statements">
                        ${icon} ${level.charAt(0).toUpperCase() + level.slice(1)}
                    </span>
                `;
            }
        },
        {
            key: 'chemical_info',
            label: 'Chemical Info',
            type: 'custom',
            filterable: true,
            sortable: false,
            width: '160px',
            format: (value) => {
                if (!value || !value.cas_numbers || value.cas_numbers.length === 0) {
                    return '<span class="text-muted small">No CAS data</span>';
                }
                const mainCAS = value.cas_numbers[0];
                const extraCount = value.cas_numbers.length - 1;
                return `
                    <div class="small">
                        <div><strong>CAS:</strong> ${mainCAS}</div>
                        ${extraCount > 0 ? `<div class="text-muted">+${extraCount} more</div>` : ''}
                    </div>
                `;
            }
        },
        {
            key: 'file_info',
            label: 'File Info',
            type: 'custom',
            filterable: false,
            sortable: true,
            width: '100px',
            format: (value, row) => {
                const size = row.file_size ? `${(row.file_size / 1024 / 1024).toFixed(1)}MB` : 'Unknown';
                const pageCount = estimatePageCount(row);
                return `
                    <div class="small text-center">
                        <div><i class="bi bi-file-pdf text-danger"></i> ${size}</div>
                        <div class="text-muted">${pageCount} pages</div>
                    </div>
                `;
            }
        },
        {
            key: 'created_date',
            label: 'Date Added',
            type: 'custom',
            filterable: true,
            sortable: true,
            width: '120px',
            format: (value, row) => {
                if (!value) return '<span class="text-muted">Unknown</span>';
                const date = new Date(typeof value === 'number' ? value * 1000 : value);
                const ageInfo = getAgeInfo(date);
                return `
                    <div class="small">
                        <div>${date.toLocaleDateString()}</div>
                        <div class="${ageInfo.class}">${ageInfo.label}</div>
                    </div>
                `;
            }
        },
        {
            key: 'actions',
            label: 'Actions',
            type: 'custom',
            filterable: false,
            sortable: false,
            width: '200px',
            format: (value, row) => `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewSDS('${row.id}')" title="View Details">
                        <i class="bi bi-eye"></i>
                    </button>
                    <a class="btn btn-outline-success" href="/sds/${row.id}/download" title="Download PDF">
                        <i class="bi bi-download"></i>
                    </a>
                    ${row.has_embeddings ? `
                        <button class="btn btn-outline-info" onclick="chatWithSDS('${row.id}')" title="AI Chat">
                            <i class="bi bi-robot"></i>
                        </button>
                    ` : `
                        <button class="btn btn-outline-secondary" onclick="indexSDS('${row.id}')" title="Enable AI">
                            <i class="bi bi-cpu"></i>
                        </button>
                    `}
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showQR('${row.id}')">
                                <i class="bi bi-qr-code"></i> QR Code
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="generateLabel('${row.id}')">
                                <i class="bi bi-tag"></i> Generate Label
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="editSDS('${row.id}')">
                                <i class="bi bi-pencil"></i> Edit Info
                            </a></li>
                            <li><a class="dropdown-item text-warning" href="#" onclick="archiveSDS('${row.id}')">
                                <i class="bi bi-archive"></i> Archive
                            </a></li>
                        </ul>
                    </div>
                </div>
            `
        }
    ];
    
    // Initialize enhanced table with smart features
    const table = initTable('sds', sdsData, sdsColumns, {
        sortable: true,
        filterable: true,
        paginated: true,
        exportable: true,
        persistPreferences: true,
        selectable: true,
        defaultSort: { column: 'created_date', direction: 'desc' },
        pageSize: 25
    });
    
    // Setup smart filters
    setupSmartFilters(table);
    populateFilterOptions(sdsData);
    updateDashboardStats(sdsData);
    
    // Setup auto-refresh for real-time updates
    setInterval(() => updateDashboardStats(table.filteredData), 300000); // 5 minutes
});

// Enhanced SDS data processing
function enhanceSDSData(rawData) {
    return rawData.map(sds => ({
        ...sds,
        hazard_level: getHazardLevel(sds),
        age_category: getAgeCategory(sds.created_date),
        search_text: createSearchText(sds)
    }));
}

function createSearchText(sds) {
    const parts = [
        sds.product_name || '',
        sds.manufacturer || '',
        sds.department || '',
        sds.country || '',
        sds.state || '',
        ...(sds.chemical_info?.cas_numbers || []),
        ...(sds.chemical_info?.hazard_statements || [])
    ];
    return parts.join(' ').toLowerCase();
}

// Smart status badges
function getStatusBadges(row) {
    const badges = [];
    
    // AI Status
    if (row.has_embeddings) {
        badges.push('<span class="badge bg-success me-1" title="AI Searchable"><i class="bi bi-robot"></i></span>');
    } else {
        badges.push('<span class="badge bg-secondary me-1" title="Not AI Indexed"><i class="bi bi-robot"></i></span>');
    }
    
    // Age status
    const ageInfo = getAgeInfo(new Date(typeof row.created_date === 'number' ? row.created_date * 1000 : row.created_date));
    if (ageInfo.category === 'new') {
        badges.push('<span class="badge bg-primary me-1" title="Recently Added">New</span>');
    } else if (ageInfo.category === 'outdated') {
        badges.push('<span class="badge bg-warning me-1" title="May need updating">‚ö†Ô∏è</span>');
    }
    
    return badges.join('');
}

function getAgeInfo(date) {
    if (!date || isNaN(date)) return { label: 'Unknown', class: 'text-muted', category: 'unknown' };
    
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    const diffMonths = Math.floor(diffDays / 30);
    const diffYears = Math.floor(diffDays / 365);
    
    if (diffDays <= 7) {
        return { label: 'New', class: 'text-success', category: 'new' };
    } else if (diffDays <= 30) {
        return { label: 'Recent', class: 'text-info', category: 'recent' };
    } else if (diffYears >= 2) {
        return { label: 'Outdated', class: 'text-warning', category: 'outdated' };
    } else if (diffMonths <= 12) {
        return { label: `${diffMonths}mo ago`, class: 'text-muted', category: 'normal' };
    } else {
        return { label: `${diffYears}yr ago`, class: 'text-muted', category: 'normal' };
    }
}

function getAgeCategory(date) {
    if (!date) return 'unknown';
    const ageInfo = getAgeInfo(new Date(typeof date === 'number' ? date * 1000 : date));
    return ageInfo.category;
}

// Hazard level analysis
function getHazardLevel(sds) {
    if (!sds.chemical_info?.hazard_statements) return 'unknown';
    
    const statements = sds.chemical_info.hazard_statements.join(' ').toLowerCase();
    
    // High risk indicators
    const highRisk = ['h300', 'h301', 'h310', 'h311', 'h330', 'h340', 'h350', 'h360', 'h370', 'h372'];
    if (highRisk.some(code => statements.includes(code))) return 'high';
    
    // Medium risk indicators
    const mediumRisk = ['h302', 'h312', 'h315', 'h317', 'h318', 'h319', 'h331', 'h335'];
    if (mediumRisk.some(code => statements.includes(code))) return 'medium';
    
    // Check for any H-codes
    if (statements.includes('h2') || statements.includes('h3') || statements.includes('h4')) return 'low';
    
    return 'unknown';
}

function getHazardColor(level) {
    const colors = {
        'high': 'bg-danger',
        'medium': 'bg-warning text-dark',
        'low': 'bg-success',
        'unknown': 'bg-secondary'
    };
    return colors[level] || 'bg-secondary';
}

function getHazardIcon(level) {
    const icons = {
        'high': 'üî¥',
        'medium': 'üü°',
        'low': 'üü¢',
        'unknown': '‚ö™'
    };
    return icons[level] || '‚ö™';
}

// Country flags
function getCountryFlag(country) {
    const flags = {
        'United States': 'üá∫üá∏', 'USA': 'üá∫üá∏',
        'Canada': 'üá®üá¶',
        'United Kingdom': 'üá¨üáß', 'UK': 'üá¨üáß',
        'Germany': 'üá©üá™',
        'France': 'üá´üá∑',
        'Japan': 'üáØüáµ',
        'China': 'üá®üá≥',
        'Australia': 'üá¶üá∫',
        'Mexico': 'üá≤üáΩ',
        'Brazil': 'üáßüá∑',
        'India': 'üáÆüá≥'
    };
    return flags[country] || 'üåç';
}

function estimatePageCount(sds) {
    if (sds.processing_metadata?.chunks_count) {
        return Math.ceil(sds.processing_metadata.chunks_count / 3); // Rough estimate
    }
    if (sds.file_size) {
        return Math.ceil(sds.file_size / 100000); // ~100KB per page estimate
    }
    return 'Unknown';
}

// Smart filters setup
function setupSmartFilters(table) {
    // Quick search
    document.getElementById('quickSearch').addEventListener('input', function() {
        const query = this.value.toLowerCase();
        table.customFilter = (item) => !query || item.search_text.includes(query);
        table.applyFilters();
    });
    
    // Filter dropdowns
    ['departmentFilter', 'countryFilter', 'hazardFilter', 'aiStatusFilter', 'ageFilter'].forEach(id => {
        document.getElementById(id).addEventListener('change', function() {
            applySmartFilters(table);
        });
    });
}

function applySmartFilters(table) {
    const filters = {
        department: document.getElementById('departmentFilter').value,
        country: document.getElementById('countryFilter').value,
        hazard: document.getElementById('hazardFilter').value,
        aiStatus: document.getElementById('aiStatusFilter').value,
        age: document.getElementById('ageFilter').value
    };
    
    table.customFilter = (item) => {
        // Department filter
        if (filters.department && item.department !== filters.department) return false;
        
        // Country filter
        if (filters.country && item.country !== filters.country) return false;
        
        // Hazard level filter
        if (filters.hazard && getHazardLevel(item) !== filters.hazard) return false;
        
        // AI status filter
        if (filters.aiStatus === 'indexed' && !item.has_embeddings) return false;
        if (filters.aiStatus === 'not_indexed' && item.has_embeddings) return false;
        
        // Age filter
        if (filters.age && getAgeCategory(item.created_date) !== filters.age) return false;
        
        return true;
    };
    
    table.applyFilters();
    updateDashboardStats(table.filteredData);
}

function populateFilterOptions(data) {
    // Populate department filter
    const departments = [...new Set(data.map(item => item.department).filter(Boolean))].sort();
    populateSelect('departmentFilter', departments);
    
    // Populate country filter
    const countries = [...new Set(data.map(item => item.country).filter(Boolean))].sort();
    populateSelect('countryFilter', countries);
    
    // Populate comparison selects
    const sdsOptions = data.map(sds => ({ value: sds.id, text: sds.product_name }));
    populateSelectWithOptions('compareSelect1', sdsOptions);
    populateSelectWithOptions('compareSelect2', sdsOptions);
    populateSelectWithOptions('labelSdsSelect', sdsOptions);
}

function populateSelect(selectId, options) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Keep the first option (usually "All")
    const firstOption = select.firstElementChild;
    select.innerHTML = '';
    if (firstOption) select.appendChild(firstOption);
    
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
    });
}

function populateSelectWithOptions(selectId, options) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Keep the first option
    const firstOption = select.firstElementChild;
    select.innerHTML = '';
    if (firstOption) select.appendChild(firstOption);
    
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        select.appendChild(optionElement);
    });
}

function updateDashboardStats(data) {
    const total = data.length;
    const aiIndexed = data.filter(item => item.has_embeddings).length;
    const outdated = data.filter(item => getAgeCategory(item.created_date) === 'outdated').length;
    const highHazard = data.filter(item => getHazardLevel(item) === 'high').length;
    const departments = [...new Set(data.map(item => item.department).filter(Boolean))].length;
    
    const now = new Date();
    const thisMonth = data.filter(item => {
        if (!item.created_date) return false;
        const date = new Date(typeof item.created_date === 'number' ? item.created_date * 1000 : item.created_date);
        return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
    }).length;
    
    document.getElementById('totalSDS').textContent = total;
    document.getElementById('aiIndexedSDS').textContent = aiIndexed;
    document.getElementById('outdatedSDS').textContent = outdated;
    document.getElementById('highHazardSDS').textContent = highHazard;
    document.getElementById('departmentsSDS').textContent = departments;
    document.getElementById('thisMonthSDS').textContent = thisMonth;
}

function clearAllFilters() {
    document.getElementById('quickSearch').value = '';
    document.getElementById('departmentFilter').value = '';
    document.getElementById('countryFilter').value = '';
    document.getElementById('hazardFilter').value = '';
    document.getElementById('aiStatusFilter').value = '';
    document.getElementById('ageFilter').value = '';
    
    const table = tableInstances['sds'];
    if (table) {
        table.customFilter = null;
        table.applyFilters();
        updateDashboardStats(table.data);
    }
}

// SDS Actions
function viewSDS(sdsId) {
    window.location.href = `/sds/${sdsId}`;
}

function chatWithSDS(sdsId) {
    window.location.href = `/sds/${sdsId}/chat`;
}

function indexSDS(sdsId) {
    if (!confirm('Index this SDS for AI search? This may take a few minutes.')) return;
    
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    button.disabled = true;
    
    fetch(`/sds/${sdsId}/index`, { method: 'POST' })
        .then(response => {
            if (response.ok) {
                button.innerHTML = '<i class="bi bi-robot text-success"></i>';
                button.title = 'AI Indexed';
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error('Failed to index SDS');
            }
        })
        .catch(error => {
            button.innerHTML = originalContent;
            button.disabled = false;
            alert('Error indexing SDS: ' + error.message);
        });
}

function editSDS(sdsId) {
    // Open edit modal or navigate to edit page
    window.location.href = `/sds/${sdsId}/edit`;
}

function archiveSDS(sdsId) {
    if (!confirm('Archive this SDS? It will be moved to the archive but not deleted.')) return;
    
    fetch(`/sds/${sdsId}/archive`, { method: 'POST' })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                throw new Error('Failed to archive SDS');
            }
        })
        .catch(error => {
            alert('Error archiving SDS: ' + error.message);
        });
}

// QR Code functionality
function showQR(sdsId) {
    const sds = tableInstances['sds'].data.find(item => item.id === sdsId);
    if (!sds) return;
    
    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    document.getElementById('qrProductName').textContent = sds.product_name;
    
    // Generate QR code
    const qrContainer = document.getElementById('qrCodeContainer');
    qrContainer.innerHTML = '<div class="spinner-border" role="status"></div>';
    
    const url = `${window.location.origin}/sds/${sdsId}`;
    
    QRCode.toCanvas(url, { width: 200, margin: 2 }, function(error, canvas) {
        if (error) {
            qrContainer.innerHTML = '<div class="text-danger">Error generating QR code</div>';
            return;
        }
        qrContainer.innerHTML = '';
        qrContainer.appendChild(canvas);
        
        // Store for download
        window.currentQRCanvas = canvas;
    });
    
    modal.show();
}

function downloadQR() {
    if (!window.currentQRCanvas) return;
    
    const link = document.createElement('a');
    link.download = 'sds-qr-code.png';
    link.href = window.currentQRCanvas.toDataURL();
    link.click();
}

// Label generation functionality
function generateLabel(sdsId) {
    const sds = tableInstances['sds'].data.find(item => item.id === sdsId);
    if (!sds) return;
    
    const modal = new bootstrap.Modal(document.getElementById('labelModal'));
    document.getElementById('labelSdsSelect').value = sdsId;
    updateLabelPreview();
    modal.show();
}

function updateLabelPreview() {
    const sdsId = document.getElementById('labelSdsSelect').value;
    const labelType = document.querySelector('input[name="labelType"]:checked').value;
    const includeQr = document.getElementById('includeQr').checked;
    
    if (!sdsId) {
        document.getElementById('labelPreview').innerHTML = '<p class="text-muted">Select an SDS to preview label</p>';
        return;
    }
    
    const sds = tableInstances['sds'].data.find(item => item.id === sdsId);
    if (!sds) return;
    
    const preview = document.getElementById('labelPreview');
    
    if (labelType === 'nfpa') {
        preview.innerHTML = generateNFPAPreview(sds, includeQr);
    } else {
        preview.innerHTML = generateGHSPreview(sds, includeQr);
    }
}

function generateNFPAPreview(sds, includeQr) {
    const hazardLevel = getHazardLevel(sds);
    const ratings = getNFPARatings(sds);
    
    return `
        <div class="nfpa-diamond" style="position: relative; width: 120px; height: 120px; margin: 0 auto;">
            <svg width="120" height="120" viewBox="0 0 120 120">
                <!-- NFPA Diamond -->
                <polygon points="60,10 110,60 60,110 10,60" fill="#fff" stroke="#000" stroke-width="2"/>
                
                <!-- Health (Blue) -->
                <polygon points="60,10 110,60 60,60" fill="#0066cc"/>
                <text x="85" y="45" text-anchor="middle" fill="white" font-weight="bold" font-size="20">${ratings.health}</text>
                
                <!-- Flammability (Red) -->
                <polygon points="10,60 60,10 60,60" fill="#cc0000"/>
                <text x="35" y="45" text-anchor="middle" fill="white" font-weight="bold" font-size="20">${ratings.fire}</text>
                
                <!-- Reactivity (Yellow) -->
                <polygon points="60,60 110,60 60,110" fill="#ffcc00"/>
                <text x="85" y="85" text-anchor="middle" fill="black" font-weight="bold" font-size="20">${ratings.reactivity}</text>
                
                <!-- Special (White) -->
                <polygon points="10,60 60,60 60,110" fill="#ffffff"/>
                <text x="35" y="85" text-anchor="middle" fill="black" font-weight="bold" font-size="16">${ratings.special}</text>
            </svg>
            ${includeQr ? '<div class="mt-2"><small>üì± QR Code</small></div>' : ''}
        </div>
        <div class="mt-2">
            <strong>${sds.product_name}</strong>
            <div class="small text-muted">${sds.manufacturer || 'Unknown Manufacturer'}</div>
        </div>
    `;
}

function generateGHSPreview(sds, includeQr) {
    const hazardLevel = getHazardLevel(sds);
    const pictograms = getGHSPictograms(sds);
    const signalWord = getGHSSignalWord(sds);
    
    return `
        <div class="ghs-label border p-3" style="max-width: 200px; margin: 0 auto;">
            <div class="text-center">
                <h6 class="fw-bold">${sds.product_name}</h6>
                <div class="my-2">
                    ${pictograms.map(p => `<span style="font-size: 24px;">${p}</span>`).join(' ')}
                </div>
                <div class="fw-bold text-danger">${signalWord}</div>
                <div class="small mt-2">
                    ${(sds.chemical_info?.hazard_statements || []).slice(0, 2).join('<br>')}
                </div>
                ${includeQr ? '<div class="mt-2"><small>üì± QR Code</small></div>' : ''}
            </div>
        </div>
    `;
}

function getNFPARatings(sds) {
    // Simplified NFPA rating logic based on hazard statements
    const statements = (sds.chemical_info?.hazard_statements || []).join(' ').toLowerCase();
    
    let health = 0, fire = 0, reactivity = 0, special = '';
    
    // Health rating
    if (statements.includes('h330') || statements.includes('h300')) health = 4;
    else if (statements.includes('h331') || statements.includes('h301')) health = 3;
    else if (statements.includes('h332') || statements.includes('h302')) health = 2;
    else if (statements.includes('h319') || statements.includes('h315')) health = 1;
    
    // Fire rating
    if (statements.includes('h224')) fire = 4;
    else if (statements.includes('h225')) fire = 3;
    else if (statements.includes('h226')) fire = 2;
    else if (statements.includes('h228')) fire = 1;
    
    // Reactivity rating
    if (statements.includes('h200') || statements.includes('h201')) reactivity = 4;
    else if (statements.includes('h202') || statements.includes('h203')) reactivity = 3;
    else if (statements.includes('h204') || statements.includes('h205')) reactivity = 2;
    else if (statements.includes('h206')) reactivity = 1;
    
    // Special hazards
    if (statements.includes('h314')) special = 'COR';
    else if (statements.includes('h270') || statements.includes('h271')) special = 'OX';
    
    return { health, fire, reactivity, special };
}

function getGHSPictograms(sds) {
    const statements = (sds.chemical_info?.hazard_statements || []).join(' ').toLowerCase();
    const pictograms = [];
    
    if (statements.includes('h200') || statements.includes('h201')) pictograms.push('üí•'); // Explosive
    if (statements.includes('h224') || statements.includes('h225')) pictograms.push('üî•'); // Flammable
    if (statements.includes('h270') || statements.includes('h271')) pictograms.push('‚≠ï'); // Oxidizing
    if (statements.includes('h300') || statements.includes('h330')) pictograms.push('‚ò†Ô∏è'); // Toxic
    if (statements.includes('h314')) pictograms.push('‚ö†Ô∏è'); // Corrosive
    if (statements.includes('h317') || statements.includes('h334')) pictograms.push('‚ö†Ô∏è'); // Health hazard
    if (statements.includes('h400') || statements.includes('h410')) pictograms.push('üåç'); // Environmental
    
    return pictograms.length > 0 ? pictograms : ['‚ö†Ô∏è'];
}

function getGHSSignalWord(sds) {
    const statements = (sds.chemical_info?.hazard_statements || []).join(' ').toLowerCase();
    
    // Danger signal words
    const dangerCodes = ['h200', 'h201', 'h224', 'h225', 'h300', 'h310', 'h314', 'h330', 'h340', 'h350', 'h360', 'h370', 'h372'];
    if (dangerCodes.some(code => statements.includes(code))) return 'DANGER';
    
    // Warning signal words
    const warningCodes = ['h226', 'h302', 'h312', 'h315', 'h317', 'h318', 'h319', 'h331', 'h332', 'h335'];
    if (warningCodes.some(code => statements.includes(code))) return 'WARNING';
    
    return 'CAUTION';
}

function downloadLabel() {
    const sdsId = document.getElementById('labelSdsSelect').value;
    const labelType = document.querySelector('input[name="labelType"]:checked').value;
    const labelSize = document.getElementById('labelSize').value;
    const includeQr = document.getElementById('includeQr').checked;
    
    if (!sdsId) {
        alert('Please select an SDS first');
        return;
    }
    
    // Create download URL with parameters
    const params = new URLSearchParams({
        type: labelType,
        size: labelSize,
        qr: includeQr
    });
    
    window.open(`/sds/${sdsId}/label?${params}`, '_blank');
}

function printLabel() {
    const preview = document.getElementById('labelPreview').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Print SDS Label</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .nfpa-diamond, .ghs-label { page-break-inside: avoid; }
                @media print {
                    body { margin: 0; }
                    .nfpa-diamond, .ghs-label { margin: 10mm; }
                }
            </style>
        </head>
        <body onload="window.print(); window.close();">
            ${preview}
        </body>
        </html>
    `);
}

// Comparison functionality
function showComparison() {
    const modal = new bootstrap.Modal(document.getElementById('comparisonModal'));
    modal.show();
}

function compareSDSFiles() {
    const id1 = document.getElementById('compareSelect1').value;
    const id2 = document.getElementById('compareSelect2').value;
    
    if (!id1 || !id2) {
        alert('Please select two SDS files to compare');
        return;
    }
    
    if (id1 === id2) {
        alert('Please select two different SDS files');
        return;
    }
    
    const sds1 = tableInstances['sds'].data.find(item => item.id === id1);
    const sds2 = tableInstances['sds'].data.find(item => item.id === id2);
    
    displayComparison(sds1, sds2);
}

function displayComparison(sds1, sds2) {
    const comparisonTable = document.getElementById('comparisonTable');
    const results = document.getElementById('comparisonResults');
    
    const compareFields = [
        { key: 'product_name', label: 'Product Name' },
        { key: 'manufacturer', label: 'Manufacturer' },
        { key: 'department', label: 'Department' },
        { key: 'country', label: 'Country' },
        { key: 'hazard_level', label: 'Hazard Level', format: (v) => getHazardIcon(getHazardLevel({chemical_info: {hazard_statements: v}})) + ' ' + v },
        { key: 'chemical_info.cas_numbers', label: 'CAS Numbers', format: (v) => Array.isArray(v) ? v.join(', ') : v },
        { key: 'has_embeddings', label: 'AI Indexed', format: (v) => v ? '‚úÖ Yes' : '‚ùå No' }
    ];
    
    let tableHTML = `
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Field</th>
                    <th>${sds1.product_name}</th>
                    <th>${sds2.product_name}</th>
                    <th>Match</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    compareFields.forEach(field => {
        const value1 = getNestedValue(sds1, field.key);
        const value2 = getNestedValue(sds2, field.key);
        const formatted1 = field.format ? field.format(value1) : value1;
        const formatted2 = field.format ? field.format(value2) : value2;
        const match = JSON.stringify(value1) === JSON.stringify(value2);
        
        tableHTML += `
            <tr class="${match ? 'table-success' : 'table-warning'}">
                <td><strong>${field.label}</strong></td>
                <td>${formatted1 || '<em>Not specified</em>'}</td>
                <td>${formatted2 || '<em>Not specified</em>'}</td>
                <td class="text-center">${match ? '‚úÖ' : '‚ùå'}</td>
            </tr>
        `;
    });
    
    tableHTML += '</tbody></table>';
    comparisonTable.innerHTML = tableHTML;
    results.style.display = 'block';
}

function getNestedValue(obj, path) {
    return path.split('.').reduce((o, key) => o && o[key], obj);
}

function generateComparisonReport() {
    // Implementation for generating PDF comparison report
    alert('Comparison report generation feature coming soon!');
}

// Bulk actions
function showBulkActions() {
    const selectedCount = getSelectedSDSCount();
    if (selectedCount === 0) {
        alert('Please select at least one SDS file first');
        return;
    }
    
    document.getElementById('selectedSDSCount').textContent = selectedCount;
    const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
    modal.show();
}

function getSelectedSDSCount() {
    return document.querySelectorAll('input[type="checkbox"]:checked').length;
}

function executeBulkAction() {
    const action = document.getElementById('bulkActionSelect').value;
    const selectedIds = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => cb.value);
    
    if (!action || selectedIds.length === 0) {
        alert('Please select an action and at least one SDS file');
        return;
    }
    
    switch (action) {
        case 'ai_index':
            bulkAIIndexSelected(selectedIds);
            break;
        case 'set_department':
            bulkSetDepartment(selectedIds);
            break;
        case 'generate_qr':
            bulkGenerateQR(selectedIds);
            break;
        case 'export':
            bulkExportSelected(selectedIds);
            break;
        case 'archive':
            bulkArchiveSelected(selectedIds);
            break;
    }
    
    bootstrap.Modal.getInstance(document.getElementById('bulkActionsModal')).hide();
}

function bulkAIIndexSelected(selectedIds) {
    if (!confirm(`Start AI indexing for ${selectedIds.length} SDS files? This may take several minutes.`)) return;
    
    fetch('/sds/bulk/ai-index', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedIds })
    })
    .then(response => {
        if (response.ok) {
            alert('AI indexing started. This will continue in the background.');
            location.reload();
        } else {
            throw new Error('Failed to start AI indexing');
        }
    })
    .catch(error => {
        alert('Error starting AI indexing: ' + error.message);
    });
}

function bulkSetDepartment(selectedIds) {
    const department = prompt(`Enter department name for ${selectedIds.length} SDS files:`);
    if (!department) return;
    
    fetch('/sds/bulk/set-department', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedIds, department: department })
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            throw new Error('Failed to update department');
        }
    })
    .catch(error => {
        alert('Error updating department: ' + error.message);
    });
}

function bulkGenerateQR(selectedIds) {
    if (!confirm(`Generate QR codes for ${selectedIds.length} SDS files?`)) return;
    
    fetch('/sds/bulk/generate-qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedIds })
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sds-qr-codes.zip';
        a.click();
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        alert('Error generating QR codes: ' + error.message);
    });
}

function bulkExportSelected(selectedIds) {
    const table = tableInstances['sds'];
    const selectedData = table.data.filter(item => selectedIds.includes(item.id));
    table.exportData(selectedData, `sds-export-${new Date().toISOString().split('T')[0]}.csv`);
}

function bulkArchiveSelected(selectedIds) {
    if (!confirm(`Archive ${selectedIds.length} SDS files? They will be moved to the archive.`)) return;
    
    fetch('/sds/bulk/archive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedIds })
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            throw new Error('Failed to archive SDS files');
        }
    })
    .catch(error => {
        alert('Error archiving SDS files: ' + error.message);
    });
}

function bulkAIIndex() {
    if (!confirm('Start AI indexing for all unindexed SDS files? This may take a long time.')) return;
    
    fetch('/sds/bulk/ai-index-all', { method: 'POST' })
        .then(response => {
            if (response.ok) {
                alert('AI indexing started for all files. This will continue in the background.');
            } else {
                throw new Error('Failed to start bulk AI indexing');
            }
        })
        .catch(error => {
            alert('Error starting bulk AI indexing: ' + error.message);
        });
}

function exportAll() {
    const table = tableInstances['sds'];
    if (table) {
        table.export();
    }
}

// Setup event listeners for dynamic elements
document.addEventListener('change', function(event) {
    if (event.target.id === 'compareSelect1' || event.target.id === 'compareSelect2') {
        const id1 = document.getElementById('compareSelect1').value;
        const id2 = document.getElementById('compareSelect2').value;
        
        if (id1 && id2) {
            compareSDSFiles();
        }
    }
    
    if (event.target.name === 'labelType' || event.target.id === 'includeQr' || event.target.id === 'labelSdsSelect') {
        updateLabelPreview();
    }
});
</script>

<style>
/* Enhanced styling for SDS features */
.card h4 {
    font-size: 1.5rem;
    font-weight: 600;
}

.card small {
    font-size: 0.875rem;
    opacity: 0.9;
}

.progress {
    background-color: rgba(255, 255, 255, 0.3) !important;
}

.progress-bar {
    background-color: rgba(255, 255, 255, 0.8) !important;
}

.badge {
    font-size: 0.75rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.025);
}

.dropdown-menu {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.table-row-highlight {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.spinner-border {
    width: 2rem;
    height: 2rem;
}

/* NFPA Diamond styling */
.nfpa-diamond svg {
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
}

/* GHS Label styling */
.ghs-label {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Smart filter panel */
.card-header {
    background-color: rgba(0, 123, 255, 0.1);
    border-bottom: 1px solid rgba(0, 123, 255, 0.2);
}

/* Status badges */
.badge.bg-success {
    background-color: #198754 !important;
}

.badge.bg-warning {
    background-color: #ffc107 !important;
    color: #000 !important;
}

.badge.bg-danger {
    background-color: #dc3545 !important;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
}

/* File size and page indicators */
.file-info {
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
}

/* Country flags */
.country-flag {
    font-size: 1.2em;
    margin-right: 0.25rem;
}

/* Hazard level indicators */
.hazard-high {
    color: #dc3545;
    font-weight: bold;
}

.hazard-medium {
    color: #ffc107;
    font-weight: bold;
}

.hazard-low {
    color: #198754;
    font-weight: bold;
}

.hazard-unknown {
    color: #6c757d;
}

/* Quick search highlight */
#quickSearch:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Comparison table styling */
.table-success {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.table-warning {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

/* Label preview styling */
#labelPreview {
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
}

/* Responsive design */
@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }
    
    .card h4 {
        font-size: 1.25rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    /* Stack stats cards on mobile */
    .row > .col-md-2 {
        margin-bottom: 1rem;
    }
    
    /* Simplify filters on mobile */
    .card-body .row.g-3 > .col-md-2,
    .card-body .row.g-3 > .col-md-3 {
        margin-bottom: 0.75rem;
    }
}

@media (max-width: 576px) {
    /* Further mobile optimizations */
    .btn-group-sm .btn {
        padding: 0.125rem 0.25rem;
        font-size: 0.75rem;
    }
    
    .dropdown-menu {
        font-size: 0.875rem;
    }
    
    /* Compact table on very small screens */
    .table td, .table th {
        padding: 0.375rem 0.25rem;
        font-size: 0.8rem;
    }
    
    /* Hide less important columns on mobile */
    .table th:nth-child(6),
    .table td:nth-child(6),
    .table th:nth-child(7),
    .table td:nth-child(7) {
        display: none;
    }
}

/* Print styles for labels */
@media print {
    .modal, .navbar, .btn, .card-header {
        display: none !important;
    }
    
    .nfpa-diamond, .ghs-label {
        page-break-inside: avoid;
        margin: 0;
    }
    
    .card-body {
        border: none;
        padding: 0;
    }
}

/* Animation for loading states */
.loading-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Enhanced tooltips */
[title] {
    cursor: help;
}

/* Status indicator animations */
.status-new {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Smart search highlighting */
.search-highlight {
    background-color: rgba(255, 255, 0, 0.3);
    padding: 0 2px;
    border-radius: 2px;
}

/* Enhanced dropdown styling */
.dropdown-menu .dropdown-item {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.dropdown-menu .dropdown-item:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.dropdown-divider {
    margin: 0.25rem 0;
}

/* Modal enhancements */
.modal-header {
    background-color: rgba(0, 123, 255, 0.1);
    border-bottom: 1px solid rgba(0, 123, 255, 0.2);
}

.modal-footer {
    background-color: rgba(248, 249, 250, 0.8);
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

/* Progress bar enhancements */
.progress {
    height: 4px;
    border-radius: 2px;
    overflow: hidden;
}

.progress-bar {
    transition: width 0.3s ease;
}

/* Table enhancements */
.table thead th {
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table tbody tr {
    transition: background-color 0.15s ease;
}

.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* Enhanced button styling */
.btn-outline-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
}

.btn-outline-success:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(25, 135, 84, 0.2);
}

.btn-outline-info:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(13, 202, 240, 0.2);
}

/* Card hover effects */
.card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.15s ease;
}

/* Form control enhancements */
.form-control:focus,
.form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Alert enhancements */
.alert {
    border-radius: 0.5rem;
    border-left: 4px solid;
}

.alert-info {
    border-left-color: #0dcaf0;
}

.alert-success {
    border-left-color: #198754;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-danger {
    border-left-color: #dc3545;
}

/* Accessibility improvements */
.btn:focus,
.form-control:focus,
.form-select:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
}

/* Dark mode support (if implemented) */
@media (prefers-color-scheme: dark) {
    .card {
        background-color: #2d3748;
        border-color: #4a5568;
    }
    
    .table {
        color: #e2e8f0;
    }
    
    .table thead th {
        border-color: #4a5568;
        color: #e2e8f0;
    }
    
    .modal-content {
        background-color: #2d3748;
        color: #e2e8f0;
    }
}
</style>

<!-- Include the dynamic table component -->
{% set table_id = 'sds' %}
{% set table_title = 'Enhanced SDS Management' %}
{% include 'components/dynamic_table.html' %}

{% endblock %}
