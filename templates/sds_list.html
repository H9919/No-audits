<!-- templates/sds_list.html - Enhanced to match Incident/CAPA style -->
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-file-earmark-text text-success"></i> SDS Library</h3>
    <div>
        <a href="{{ url_for('sds.sds_upload') }}" class="btn btn-primary">
            <i class="bi bi-cloud-upload"></i> Upload SDS
        </a>
        <a href="{{ url_for('sds.sds_search') }}" class="btn btn-outline-primary">
            <i class="bi bi-search"></i> AI Search
        </a>
        <div class="btn-group ms-2" role="group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i> More
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="showBulkUpload()">
                    <i class="bi bi-upload"></i> Bulk Upload (ZIP)
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="showBulkActions()">
                    <i class="bi bi-check2-square"></i> Bulk Actions
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="showAnalytics()">
                    <i class="bi bi-graph-up"></i> Analytics
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="exportAll()">
                    <i class="bi bi-download"></i> Export All
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="reindexAll()">
                    <i class="bi bi-cpu"></i> Rebuild AI Index
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Enhanced Stats Dashboard -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 id="totalSDS">{{ sds_list|length }}</h4>
                <small>Total SDS</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 id="aiIndexedSDS">{{ sds_list|selectattr("has_embeddings", "equalto", true)|list|length }}</h4>
                <small>AI Searchable</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((sds_list|selectattr('has_embeddings', 'equalto', true)|list|length) / (sds_list|length) * 100) if sds_list|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 id="departmentsSDS">{{ sds_list|map(attribute="department")|unique|list|length }}</h4>
                <small>Departments</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: 75%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 id="thisMonthSDS">{{ sds_list|selectattr("created_date")|select("test", ">=", moment().subtract(30, 'days').format('YYYY-MM-DD'))|list|length }}</h4>
                <small>Added This Month</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((sds_list|selectattr('created_date')|select('test', '>=', moment().subtract(30, 'days').format('YYYY-MM-DD'))|list|length) / (sds_list|length) * 100) if sds_list|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filters Section -->
<div class="card mb-4" id="advancedFilters" style="display: none;">
    <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-funnel"></i> Advanced Filters</h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="departmentFilter">
                    <option value="">All Departments</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Manufacturer</label>
                <select class="form-select" id="manufacturerFilter">
                    <option value="">All Manufacturers</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Country</label>
                <select class="form-select" id="countryFilter">
                    <option value="">All Countries</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">State/Province</label>
                <select class="form-select" id="stateFilter">
                    <option value="">All States/Provinces</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
        </div>
        <div class="row g-3 mt-2">
            <div class="col-md-3">
                <label class="form-label">Hazard Classification</label>
                <select class="form-select" id="hazardFilter">
                    <option value="">All Hazard Types</option>
                    <option value="flammable">Flammable</option>
                    <option value="toxic">Toxic</option>
                    <option value="corrosive">Corrosive</option>
                    <option value="oxidizing">Oxidizing</option>
                    <option value="harmful">Harmful/Irritant</option>
                    <option value="environmental">Environmental Hazard</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">AI Indexed</label>
                <select class="form-select" id="aiIndexedFilter">
                    <option value="">All</option>
                    <option value="true">AI Searchable</option>
                    <option value="false">Not Indexed</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">File Size</label>
                <select class="form-select" id="fileSizeFilter">
                    <option value="">All Sizes</option>
                    <option value="small">< 1 MB</option>
                    <option value="medium">1-5 MB</option>
                    <option value="large">> 5 MB</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Date Added</label>
                <select class="form-select" id="dateAddedFilter">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Main SDS Table -->
<div id="sdsTableContainer">
    <!-- Dynamic table will be rendered here -->
</div>

<!-- Include the dynamic table component -->
{% set table_id = 'sds' %}
{% set table_title = 'SDS Management' %}
{% include 'components/dynamic_table.html' %}

<!-- Bulk Upload Modal -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" id="bulkUploadForm" enctype="multipart/form-data" method="post" action="{{ url_for('sds.sds_bulk_upload') }}">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-upload"></i> Bulk Upload SDS (ZIP)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Upload Guidelines</h6>
                    <ul class="mb-0">
                        <li>Upload a .zip file containing multiple PDF files</li>
                        <li>Each PDF should be a Safety Data Sheet</li>
                        <li>Files will be automatically processed for AI search</li>
                        <li>Maximum size: 100MB per ZIP file</li>
                    </ul>
                </div>
                <div class="mb-3">
                    <label class="form-label">Select ZIP File</label>
                    <input class="form-control" type="file" name="zip_file" accept=".zip" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Default Department (Optional)</label>
                    <input class="form-control" type="text" name="default_department" placeholder="e.g., Manufacturing">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-upload"></i> Upload and Process
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Action</label>
                    <select class="form-select" id="bulkActionSelect">
                        <option value="">Choose action...</option>
                        <option value="export">Export Selected</option>
                        <option value="reindex">Rebuild AI Index</option>
                        <option value="department">Set Department</option>
                        <option value="delete">Delete Selected</option>
                    </select>
                </div>
                <div id="bulkActionOptions" class="d-none">
                    <!-- Options will be populated based on selected action -->
                </div>
                <div class="alert alert-info">
                    <span id="selectedSDSCount">0</span> SDS files selected
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkAction()">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- SDS Preview Modal -->
<div class="modal fade" id="sdsPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> SDS Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sdsPreviewBody">
                <div class="text-center text-muted py-5">
                    <div class="spinner-border"></div>
                    <p class="mt-2">Loading SDS preview...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadFromPreview">
                    <i class="bi bi-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">SDS Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="departmentChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="manufacturerChart"></canvas>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <canvas id="hazardChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // SDS data from server
    const sdsData = {{ sds_list|tojson }};
    
    // Enhanced column configuration with new fields
    const sdsColumns = [
        {
            key: 'id',
            label: 'SDS ID',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value) => `<code>${value.substring(0, 8)}</code>`
        },
        {
            key: 'product_name',
            label: 'Product Name',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) => {
                const hasAI = row.has_embeddings ? 
                    '<i class="bi bi-robot text-primary ms-1" title="AI Searchable"></i>' : 
                    '<i class="bi bi-robot text-muted ms-1" title="Not AI Indexed"></i>';
                const truncated = value.length > 40 ? value.substring(0, 40) + '...' : value;
                return `<strong>${truncated}</strong>${hasAI}`;
            }
        },
        {
            key: 'department',
            label: 'Department',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value) => value ? 
                `<span class="badge bg-info">${value}</span>` : 
                '<span class="text-muted">Not specified</span>'
        },
        {
            key: 'manufacturer',
            label: 'Manufacturer',
            type: 'text',
            filterable: true,
            sortable: true,
            format: (value) => value || '<span class="text-muted">Unknown</span>'
        },
        {
            key: 'country',
            label: 'Country',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value) => {
                if (!value) return '<span class="text-muted">—</span>';
                const flagEmoji = getCountryFlag(value);
                return `${flagEmoji} ${value}`;
            }
        },
        {
            key: 'state',
            label: 'State/Province',
            type: 'text',
            filterable: true,
            sortable: true,
            format: (value) => value || '<span class="text-muted">—</span>'
        },
        {
            key: 'chemical_info',
            label: 'Chemical Info',
            type: 'custom',
            filterable: true,
            sortable: false,
            format: (value) => {
                if (!value || !value.cas_numbers || value.cas_numbers.length === 0) {
                    return '<span class="text-muted">No CAS numbers</span>';
                }
                const displayCAS = value.cas_numbers.slice(0, 1).map(cas =>
                    `<span class="badge bg-light text-dark">${cas}</span>`
                ).join(' ');
                const extra = value.cas_numbers.length > 1 ?
                    ` <small class="text-muted">+${value.cas_numbers.length - 1}</small>` : '';
                return displayCAS + extra;
            }
        },
        {
            key: 'hazard_info',
            label: 'Hazards',
            type: 'custom',
            filterable: false,
            sortable: false,
            format: (value, row) => {
                const hazards = row.chemical_info?.hazard_statements || [];
                if (hazards.length === 0) return '<span class="text-muted">None listed</span>';

                const displayHazards = hazards.slice(0, 2).map(h => {
                    const hCode = h.match(/H\d{3}/)?.[0] || '';
                    const colorClass = getHazardColor(hCode);
                    return `<span class="badge ${colorClass}">${hCode || h.substring(0, 10)}</span>`;
                }).join(' ');
                const extra = hazards.length > 2 ?
                    ` <small class="text-muted">+${hazards.length - 2}</small>` : '';
                return displayHazards + extra;
            }
        },
        {
            key: 'file_info',
            label: 'File Info',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) => {
                const size = row.file_size ?
                    `${(row.file_size / 1024 / 1024).toFixed(1)}MB` : 'Unknown';
                const chunks = row.processing_metadata?.chunks_count || 0;
                return `
                    <div class="small">
                        <div><i class="bi bi-file-pdf text-danger"></i> ${size}</div>
                        <div class="text-muted">${chunks} chunks</div>
                    </div>
                `;
            }
        },
        {
            key: 'created_date',
            label: 'Added Date',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value) => {
                if (!value) return '<span class="text-muted">Unknown</span>';
                const date = new Date(typeof value === 'number' ? value * 1000 : value);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                
                let badge = '';
                if (diffDays <= 1) {
                    badge = ' <span class="badge bg-success">New</span>';
                } else if (diffDays <= 7) {
                    badge = ' <span class="badge bg-primary">Recent</span>';
                }
                
                return date.toLocaleDateString() + badge;
            }
        },
        {
            key: 'actions',
            label: 'Actions',
            type: 'custom',
            filterable: false,
            sortable: false,
            format: (value, row) => `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="previewSDS('${row.id}')" title="View SDS">
                        <i class="bi bi-eye"></i>
                    </button>
                    <a class="btn btn-outline-success" href="/sds/${row.id}/download" title="Download PDF">
                        <i class="bi bi-download"></i>
                    </a>
                    ${row.has_embeddings ? `
                        <a class="btn btn-outline-info" href="/sds/${row.id}/chat" title="AI Chat">
                            <i class="bi bi-robot"></i>
                        </a>
                    ` : `
                        <button class="btn btn-outline-secondary" onclick="indexSDS('${row.id}')" title="Index for AI">
                            <i class="bi bi-cpu"></i>
                        </button>
                    `}
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/sds/${row.id}/qr">
                                <i class="bi bi-qr-code"></i> QR Code
                            </a></li>
                            <li><a class="dropdown-item" href="/sds/${row.id}/label">
                                <i class="bi bi-tag"></i> Generate Label
                            </a></li>
                            <li><a class="dropdown-item" href="/sds/${row.id}">
                                <i class="bi bi-info-circle"></i> Details
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="editSDS('${row.id}')">
                                <i class="bi bi-pencil"></i> Edit Info
                            </a></li>
                            <li><a class="dropdown-item text-warning" href="#" onclick="deleteSDS('${row.id}')">
                                <i class="bi bi-trash"></i> Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
            `
        }
    ];
    
    // Initialize the dynamic table
    const table = initTable('sds', sdsData, sdsColumns, {
        sortable: true,
        filterable: true,
        paginated: true,
        exportable: true,
        persistPreferences: true,
        selectable: true,
        defaultSort: { column: 'created_date', direction: 'desc' }
    });
    
    // Setup advanced filters
    setupAdvancedFilters();
    populateFilterOptions();
    
    // Setup auto-refresh for real-time updates
    setInterval(loadSDSStats, 300000); // Refresh every 5 minutes
});

function getCountryFlag(country) {
    const flags = {
        'United States': '🇺🇸',
        'Canada': '🇨🇦',
        'United Kingdom': '🇬🇧',
        'Germany': '🇩🇪',
        'France': '🇫🇷',
        'Japan': '🇯🇵',
        'China': '🇨🇳',
        'Australia': '🇦🇺'
    };
    return flags[country] || '🌍';
}

function getHazardColor(hCode) {
    if (!hCode) return 'bg-secondary';
    const code = parseInt(hCode.substring(1));
    if (code >= 200 && code < 300) return 'bg-danger'; // Physical hazards
    if (code >= 300 && code < 400) return 'bg-warning'; // Health hazards
    if (code >= 400 && code < 500) return 'bg-info'; // Environmental hazards
    return 'bg-secondary';
}

function setupAdvancedFilters() {
    ['departmentFilter', 'manufacturerFilter', 'countryFilter', 'stateFilter', 
     'hazardFilter', 'aiIndexedFilter', 'fileSizeFilter', 'dateAddedFilter'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', applyAdvancedFilters);
        }
    });
}

function populateFilterOptions() {
    const data = tableInstances['sds'].data;
    
    // Populate department filter
    const departments = [...new Set(data.map(item => item.department).filter(Boolean))];
    populateSelect('departmentFilter', departments);
    
    // Populate manufacturer filter
    const manufacturers = [...new Set(data.map(item => item.manufacturer).filter(Boolean))];
    populateSelect('manufacturerFilter', manufacturers);
    
    // Populate country filter
    const countries = [...new Set(data.map(item => item.country).filter(Boolean))];
    populateSelect('countryFilter', countries);
    
    // Populate state filter
    const states = [...new Set(data.map(item => item.state).filter(Boolean))];
    populateSelect('stateFilter', states);
}

function populateSelect(selectId, options) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    options.sort().forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
    });
}

function applyAdvancedFilters() {
    const table = tableInstances['sds'];
    if (!table) return;
    
    const department = document.getElementById('departmentFilter').value;
    const manufacturer = document.getElementById('manufacturerFilter').value;
    const country = document.getElementById('countryFilter').value;
    const state = document.getElementById('stateFilter').value;
    const hazard = document.getElementById('hazardFilter').value;
    const aiIndexed = document.getElementById('aiIndexedFilter').value;
    const fileSize = document.getElementById('fileSizeFilter').value;
    const dateAdded = document.getElementById('dateAddedFilter').value;
    
    let filteredData = [...table.data];
    
    // Apply filters
    if (department) {
        filteredData = filteredData.filter(item => item.department === department);
    }
    
    if (manufacturer) {
        filteredData = filteredData.filter(item => item.manufacturer === manufacturer);
    }
    
    if (country) {
        filteredData = filteredData.filter(item => item.country === country);
    }
    
    if (state) {
        filteredData = filteredData.filter(item => item.state === state);
    }
    
    if (aiIndexed) {
        const isIndexed = aiIndexed === 'true';
        filteredData = filteredData.filter(item => item.has_embeddings === isIndexed);
    }
    
    if (fileSize) {
        filteredData = filteredData.filter(item => {
            const size = item.file_size / 1024 / 1024; // Convert to MB
            switch (fileSize) {
                case 'small': return size < 1;
                case 'medium': return size >= 1 && size <= 5;
                case 'large': return size > 5;
                default: return true;
            }
        });
    }
    
    if (hazard) {
        filteredData = filteredData.filter(item => {
            const hazards = item.chemical_info?.hazard_statements || [];
            return hazards.some(h => h.toLowerCase().includes(hazard));
        });
    }
    
    if (dateAdded) {
        const now = new Date();
        let cutoffDate = new Date();
        
        switch (dateAdded) {
            case 'today':
                cutoffDate.setHours(0, 0, 0, 0);
                break;
            case 'week':
                cutoffDate.setDate(now.getDate() - 7);
                break;
            case 'month':
                cutoffDate.setMonth(now.getMonth() - 1);
                break;
            case 'quarter':
                cutoffDate.setMonth(now.getMonth() - 3);
                break;
            case 'year':
                cutoffDate.setFullYear(now.getFullYear() - 1);
                break;
        }
        
        filteredData = filteredData.filter(item => {
            if (!item.created_date) return false;
            const itemDate = new Date(typeof item.created_date === 'number' ? item.created_date * 1000 : item.created_date);
            return itemDate >= cutoffDate;
        });
    }
    
    table.filteredData = filteredData;
    table.currentPage = 1;
    table.render();
    updateFilteredStats(filteredData);
}

function updateFilteredStats(filteredData) {
    document.getElementById('totalSDS').textContent = filteredData.length;
    document.getElementById('aiIndexedSDS').textContent = 
        filteredData.filter(item => item.has_embeddings).length;
    document.getElementById('departmentsSDS').textContent = 
        [...new Set(filteredData.map(item => item.department).filter(Boolean))].length;
    
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById('thisMonthSDS').textContent = 
        filteredData.filter(item => {
            if (!item.created_date) return false;
            const itemDate = new Date(typeof item.created_date === 'number' ? item.created_date * 1000 : item.created_date);
            return itemDate >= thirtyDaysAgo;
        }).length;
}

function loadSDSStats() {
    fetch('/api/sds/stats')
        .then(response => response.json())
        .then(data => {
            if (data.total !== undefined) {
                document.getElementById('totalSDS').textContent = data.total;
            }
            if (data.ai_indexed !== undefined) {
                document.getElementById('aiIndexedSDS').textContent = data.ai_indexed;
            }
            if (data.departments !== undefined) {
                document.getElementById('departmentsSDS').textContent = data.departments;
            }
            if (data.this_month !== undefined) {
                document.getElementById('thisMonthSDS').textContent = data.this_month;
            }
        })
        .catch(error => {
            console.error('Error loading SDS stats:', error);
        });
}

function toggleAdvancedFilters() {
    const panel = document.getElementById('advancedFilters');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// SDS Action Functions
function previewSDS(sdsId) {
    const modal = new bootstrap.Modal(document.getElementById('sdsPreviewModal'));
    const body = document.getElementById('sdsPreviewBody');
    const downloadBtn = document.getElementById('downloadFromPreview');
    
    body.innerHTML = `
        <div class="text-center text-muted py-5">
            <div class="spinner-border"></div>
            <p class="mt-2">Loading SDS preview...</p>
        </div>
    `;
    
    downloadBtn.onclick = () => window.location.href = `/sds/${sdsId}/download`;
    modal.show();
    
    fetch(`/sds/${sdsId}/view_inline`)
        .then(response => response.ok ? response.text() : 
            '<div class="alert alert-danger">Failed to load SDS preview.</div>')
        .then(html => {
            body.innerHTML = html;
        })
        .catch(error => {
            body.innerHTML = '<div class="alert alert-danger">Error loading SDS preview.</div>';
            console.error('Error loading SDS preview:', error);
        });
}

function indexSDS(sdsId) {
    if (!confirm('Index this SDS for AI search? This may take a few minutes.')) return;
    
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    button.disabled = true;
    
    fetch(`/sds/${sdsId}/index`, { method: 'POST' })
        .then(response => {
            if (response.ok) {
                button.innerHTML = '<i class="bi bi-robot text-success"></i>';
                button.title = 'AI Indexed';
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error('Failed to index SDS');
            }
        })
        .catch(error => {
            button.innerHTML = originalContent;
            button.disabled = false;
            alert('Error indexing SDS: ' + error.message);
        });
}

function editSDS(sdsId) {
    // This would open an edit modal or navigate to edit page
    console.log('Edit SDS:', sdsId);
    alert('Edit functionality would be implemented here.');
}

function deleteSDS(sdsId) {
    if (!confirm('Are you sure you want to delete this SDS? This action cannot be undone.')) return;
    
    fetch(`/sds/${sdsId}`, { method: 'DELETE' })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                throw new Error('Failed to delete SDS');
            }
        })
        .catch(error => {
            alert('Error deleting SDS: ' + error.message);
        });
}

// Modal Functions
function showBulkUpload() {
    const modal = new bootstrap.Modal(document.getElementById('bulkUploadModal'));
    modal.show();
}

function showBulkActions() {
    const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
    modal.show();
}

function showAnalytics() {
    const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
    modal.show();
    
    // Generate charts after modal is shown
    setTimeout(() => {
        generateAnalyticsCharts();
    }, 300);
}

function generateAnalyticsCharts() {
    const data = tableInstances['sds'].data;
    
    // Department Distribution Chart
    const deptCtx = document.getElementById('departmentChart').getContext('2d');
    const deptCounts = {};
    data.forEach(sds => {
        const dept = sds.department || 'Unspecified';
        deptCounts[dept] = (deptCounts[dept] || 0) + 1;
    });
    
    new Chart(deptCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(deptCounts),
            datasets: [{
                data: Object.values(deptCounts),
                backgroundColor: [
                    '#0dcaf0', '#198754', '#ffc107', '#fd7e14', 
                    '#6f42c1', '#dc3545', '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'SDS by Department'
                }
            }
        }
    });
    
    // Manufacturer Chart
    const manuCtx = document.getElementById('manufacturerChart').getContext('2d');
    const manuCounts = {};
    data.forEach(sds => {
        const manu = sds.manufacturer || 'Unknown';
        manuCounts[manu] = (manuCounts[manu] || 0) + 1;
    });
    
    // Get top 10 manufacturers
    const topManufacturers = Object.entries(manuCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);
    
    new Chart(manuCtx, {
        type: 'bar',
        data: {
            labels: topManufacturers.map(([name]) => name.length > 15 ? name.substring(0, 15) + '...' : name),
            datasets: [{
                label: 'Number of SDS',
                data: topManufacturers.map(([, count]) => count),
                backgroundColor: '#198754'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Top Manufacturers'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Hazard Types Chart
    const hazardCtx = document.getElementById('hazardChart').getContext('2d');
    const hazardCounts = {
        'Flammable': 0,
        'Toxic': 0,
        'Corrosive': 0,
        'Oxidizing': 0,
        'Harmful': 0,
        'Environmental': 0,
        'Other': 0
    };
    
    data.forEach(sds => {
        const hazards = sds.chemical_info?.hazard_statements || [];
        if (hazards.length === 0) {
            hazardCounts['Other']++;
            return;
        }
        
        hazards.forEach(hazard => {
            const h = hazard.toLowerCase();
            if (h.includes('flam')) hazardCounts['Flammable']++;
            else if (h.includes('toxic') || h.includes('poison')) hazardCounts['Toxic']++;
            else if (h.includes('corros')) hazardCounts['Corrosive']++;
            else if (h.includes('oxid')) hazardCounts['Oxidizing']++;
            else if (h.includes('harm') || h.includes('irrit')) hazardCounts['Harmful']++;
            else if (h.includes('environment')) hazardCounts['Environmental']++;
            else hazardCounts['Other']++;
        });
    });
    
    new Chart(hazardCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(hazardCounts),
            datasets: [{
                data: Object.values(hazardCounts),
                backgroundColor: [
                    '#dc3545', '#fd7e14', '#ffc107', '#198754',
                    '#0dcaf0', '#6f42c1', '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Hazard Classifications'
                }
            }
        }
    });
    
    // Trends Chart (SDS added over time)
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    const monthlyCounts = {};
    
    data.forEach(sds => {
        if (!sds.created_date) return;
        const date = new Date(typeof sds.created_date === 'number' ? sds.created_date * 1000 : sds.created_date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthlyCounts[monthKey] = (monthlyCounts[monthKey] || 0) + 1;
    });
    
    const sortedMonths = Object.keys(monthlyCounts).sort();
    const last12Months = sortedMonths.slice(-12);
    
    new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: last12Months.map(month => {
                const [year, monthNum] = month.split('-');
                return new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            }),
            datasets: [{
                label: 'SDS Added',
                data: last12Months.map(month => monthlyCounts[month] || 0),
                borderColor: '#0dcaf0',
                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'SDS Addition Trends (Last 12 Months)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function executeBulkAction() {
    const action = document.getElementById('bulkActionSelect').value;
    const selectedIds = getSelectedSDSIds();
    
    if (!action || selectedIds.length === 0) {
        alert('Please select an action and at least one SDS file.');
        return;
    }
    
    switch (action) {
        case 'export':
            exportSelectedSDS(selectedIds);
            break;
        case 'reindex':
            reindexSelectedSDS(selectedIds);
            break;
        case 'department':
            setDepartmentForSelected(selectedIds);
            break;
        case 'delete':
            deleteSelectedSDS(selectedIds);
            break;
    }
    
    bootstrap.Modal.getInstance(document.getElementById('bulkActionsModal')).hide();
}

function getSelectedSDSIds() {
    // Implementation for getting selected rows
    // This would integrate with your table selection mechanism
    return [];
}

function exportSelectedSDS(selectedIds) {
    // Implementation for exporting selected SDS
    console.log('Exporting SDS:', selectedIds);
}

function reindexSelectedSDS(selectedIds) {
    if (!confirm(`Reindex ${selectedIds.length} SDS files for AI search? This may take several minutes.`)) return;
    
    fetch('/sds/bulk/reindex', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedIds })
    })
    .then(response => {
        if (response.ok) {
            alert('Reindexing started. This will continue in the background.');
            location.reload();
        } else {
            throw new Error('Failed to start reindexing');
        }
    })
    .catch(error => {
        alert('Error starting reindex: ' + error.message);
    });
}

function setDepartmentForSelected(selectedIds) {
    const department = prompt('Enter department name for selected SDS files:');
    if (!department) return;
    
    fetch('/sds/bulk/set-department', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedIds, department: department })
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            throw new Error('Failed to update department');
        }
    })
    .catch(error => {
        alert('Error updating department: ' + error.message);
    });
}

function deleteSelectedSDS(selectedIds) {
    if (!confirm(`Are you sure you want to delete ${selectedIds.length} SDS files? This action cannot be undone.`)) return;
    
    fetch('/sds/bulk/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedIds })
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            throw new Error('Failed to delete SDS files');
        }
    })
    .catch(error => {
        alert('Error deleting SDS files: ' + error.message);
    });
}

function exportAll() {
    tableInstances['sds']?.export();
}

function reindexAll() {
    if (!confirm('Rebuild AI index for all SDS files? This may take a long time.')) return;
    
    fetch('/sds/reindex-all', { method: 'POST' })
        .then(response => {
            if (response.ok) {
                alert('Reindexing started. This will continue in the background.');
                location.reload();
            } else {
                throw new Error('Failed to start reindexing');
            }
        })
        .catch(error => {
            alert('Error starting reindex: ' + error.message);
        });
}

// Global functions for table interactions
window.previewSDS = previewSDS;
window.indexSDS = indexSDS;
window.editSDS = editSDS;
window.deleteSDS = deleteSDS;
window.showBulkUpload = showBulkUpload;
window.showBulkActions = showBulkActions;
window.showAnalytics = showAnalytics;
window.exportAll = exportAll;
window.reindexAll = reindexAll;
window.toggleAdvancedFilters = toggleAdvancedFilters;
</script>

<style>
.card h4 {
    font-size: 1.5rem;
    font-weight: 600;
}

.card small {
    font-size: 0.875rem;
    opacity: 0.9;
}

.progress {
    background-color: rgba(255, 255, 255, 0.3) !important;
}

.progress-bar {
    background-color: rgba(255, 255, 255, 0.8) !important;
}

.badge {
    font-size: 0.75rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.025);
}

.dropdown-menu {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.table-row-highlight {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.spinner-border {
    width: 2rem;
    height: 2rem;
}

@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }
    
    .card h4 {
        font-size: 1.25rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}

/* Modal content styling */
#sdsPreviewBody {
    max-height: 70vh;
    overflow-y: auto;
}

/* Enhanced badge styling */
.badge.bg-light {
    color: #495057 !important;
    border: 1px solid #dee2e6;
}

/* File size styling */
.small .bi-file-pdf {
    font-size: 1rem;
}

/* Country flag styling */
.table td {
    vertical-align: middle;
}

/* Hazard badge styling */
.badge.bg-danger {
    font-weight: 500;
}

.badge.bg-warning {
    color: #000 !important;
    font-weight: 500;
}

.badge.bg-info {
    font-weight: 500;
}

/* AI status styling */
.bi-robot.text-primary {
    color: #0d6efd !important;
}

.bi-robot.text-muted {
    color: #6c757d !important;
}

/* Loading state */
.btn:disabled {
    opacity: 0.65;
}

/* Filter panel styling */
.card-header h6 {
    font-weight: 600;
}

/* Advanced filters responsive */
@media (max-width: 576px) {
    #advancedFilters .row.g-3 > div {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}
