<!-- templates/sds_list.html - Proper SDS Template with Real Data -->
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-file-earmark-text text-success"></i> SDS Library</h3>
    <div>
        <a href="{{ url_for('sds.sds_upload') }}" class="btn btn-primary">
            <i class="bi bi-cloud-upload"></i> Upload SDS
        </a>
        <button class="btn btn-outline-info" onclick="showComparison()">
            <i class="bi bi-files"></i> Compare SDS
        </button>
        <div class="btn-group ms-2" role="group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i> Tools
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="showBulkActions()">
                    <i class="bi bi-check2-square"></i> Bulk Actions
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="showAnalytics()">
                    <i class="bi bi-graph-up"></i> Analytics
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="bulkAIIndex()">
                    <i class="bi bi-cpu"></i> Bulk AI Index
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="exportAll()">
                    <i class="bi bi-download"></i> Export All
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Enhanced Stats Dashboard -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 id="totalSDS">{{ sds_list|length }}</h4>
                <small>Total SDS</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 id="aiIndexedSDS">{{ sds_list|selectattr("has_embeddings", "equalto", true)|list|length }}</h4>
                <small>AI Searchable</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((sds_list|selectattr('has_embeddings', 'equalto', true)|list|length) / (sds_list|length) * 100) if sds_list|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 id="outdatedSDS">{{ sds_list|selectattr("is_outdated", "equalto", true)|list|length }}</h4>
                <small>Outdated (>2yr)</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((sds_list|selectattr('is_outdated', 'equalto', true)|list|length) / (sds_list|length) * 100) if sds_list|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4 id="highHazardSDS">{{ sds_list|selectattr("hazard_level", "equalto", "high")|list|length }}</h4>
                <small>High Hazard</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((sds_list|selectattr('hazard_level', 'equalto', 'high')|list|length) / (sds_list|length) * 100) if sds_list|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 id="departmentsSDS">{{ sds_list|map(attribute="department")|select|unique|list|length }}</h4>
                <small>Departments</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: 75%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h4 id="thisMonthSDS">{{ sds_list|selectattr("is_new", "equalto", true)|list|length }}</h4>
                <small>Added This Month</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((sds_list|selectattr('is_new', 'equalto', true)|list|length) / (sds_list|length) * 100) if sds_list|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Smart Filters Panel -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-funnel"></i> Smart Filters</h6>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
                <i class="bi bi-x-circle"></i> Clear All
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <!-- Quick Search -->
            <div class="col-md-3">
                <label class="form-label">Quick Search</label>
                <input type="text" class="form-control" id="quickSearch" placeholder="Product, CAS, Chemical...">
            </div>
            
            <!-- Department Filter -->
            <div class="col-md-2">
                <label class="form-label">Department</label>
                <select class="form-select" id="departmentFilter">
                    <option value="">All Departments</option>
                    {% for dept in sds_list|map(attribute="department")|select|unique|sort %}
                    <option value="{{ dept }}">{{ dept }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Country Filter -->
            <div class="col-md-2">
                <label class="form-label">Country</label>
                <select class="form-select" id="countryFilter">
                    <option value="">All Countries</option>
                    {% for country in sds_list|map(attribute="country")|select|unique|sort %}
                    <option value="{{ country }}">{{ country }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Hazard Level Filter -->
            <div class="col-md-2">
                <label class="form-label">Hazard Level</label>
                <select class="form-select" id="hazardFilter">
                    <option value="">All Levels</option>
                    <option value="high">üî¥ High Risk</option>
                    <option value="medium">üü° Medium Risk</option>
                    <option value="low">üü¢ Low Risk</option>
                    <option value="unknown">‚ö™ Unknown</option>
                </select>
            </div>
            
            <!-- AI Index Status -->
            <div class="col-md-2">
                <label class="form-label">AI Status</label>
                <select class="form-select" id="aiStatusFilter">
                    <option value="">All</option>
                    <option value="indexed">ü§ñ AI Searchable</option>
                    <option value="not_indexed">üìÑ Not Indexed</option>
                </select>
            </div>
            
            <!-- Age Filter -->
            <div class="col-md-1">
                <label class="form-label">Age</label>
                <select class="form-select" id="ageFilter">
                    <option value="">All</option>
                    <option value="new">üìÖ New</option>
                    <option value="outdated">‚ö†Ô∏è Old</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Actual SDS Table -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-table"></i> SDS Records 
                <span class="badge bg-primary" id="recordCount">{{ sds_list|length }}</span>
            </h6>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="toggleView('table')">
                    <i class="bi bi-table"></i> Table
                </button>
                <button class="btn btn-outline-secondary" onclick="toggleView('grid')">
                    <i class="bi bi-grid-3x3"></i> Grid
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" id="tableView">
            <table class="table table-hover mb-0" id="sdsTable">
                <thead class="table-light">
                    <tr>
                        <th width="80">
                            <input type="checkbox" class="form-check-input" onchange="toggleAllSelection(this)">
                        </th>
                        <th width="100">SDS ID</th>
                        <th width="280">Product Name</th>
                        <th width="120">Department</th>
                        <th width="140">Location</th>
                        <th width="140">Manufacturer</th>
                        <th width="120">Hazard Level</th>
                        <th width="160">Chemical Info</th>
                        <th width="100">File Info</th>
                        <th width="120">Date Added</th>
                        <th width="200">Actions</th>
                    </tr>
                </thead>
                <tbody id="sdsTableBody">
                    {% for sds in sds_list %}
                    <tr data-sds-id="{{ sds.id }}" class="sds-row">
                        <td>
                            <input type="checkbox" class="form-check-input row-selector" value="{{ sds.id }}">
                        </td>
                        <td>
                            <code class="small">{{ sds.id[:8] }}</code>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <strong class="text-truncate" title="{{ sds.product_name }}">
                                    {{ sds.product_name[:35] + '...' if sds.product_name|length > 35 else sds.product_name }}
                                </strong>
                                <div class="mt-1">
                                    {% if sds.has_embeddings %}
                                    <span class="badge bg-success me-1" title="AI Searchable">
                                        <i class="bi bi-robot"></i>
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary me-1" title="Not AI Indexed">
                                        <i class="bi bi-robot"></i>
                                    </span>
                                    {% endif %}
                                    
                                    {% if sds.is_new %}
                                    <span class="badge bg-primary me-1" title="Recently Added">New</span>
                                    {% elif sds.is_outdated %}
                                    <span class="badge bg-warning me-1" title="May need updating">‚ö†Ô∏è</span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if sds.department %}
                            <span class="badge bg-info text-truncate">{{ sds.department }}</span>
                            {% else %}
                            <span class="text-muted small">Unassigned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if sds.country %}
                            <div class="small">
                                <div>
                                    {% if sds.country == 'United States' %}üá∫üá∏
                                    {% elif sds.country == 'Canada' %}üá®üá¶
                                    {% elif sds.country == 'United Kingdom' %}üá¨üáß
                                    {% elif sds.country == 'Germany' %}üá©üá™
                                    {% elif sds.country == 'France' %}üá´üá∑
                                    {% elif sds.country == 'Japan' %}üáØüáµ
                                    {% elif sds.country == 'China' %}üá®üá≥
                                    {% elif sds.country == 'Australia' %}üá¶üá∫
                                    {% else %}üåç{% endif %}
                                    {{ sds.country }}
                                </div>
                                {% if sds.state %}
                                <div class="text-muted">{{ sds.state }}</div>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if sds.manufacturer %}
                            {{ sds.manufacturer[:20] + '...' if sds.manufacturer|length > 20 else sds.manufacturer }}
                            {% else %}
                            <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set hazard = sds.hazard_level %}
                            {% if hazard == 'high' %}
                            <span class="badge bg-danger" title="High Risk">üî¥ High</span>
                            {% elif hazard == 'medium' %}
                            <span class="badge bg-warning text-dark" title="Medium Risk">üü° Medium</span>
                            {% elif hazard == 'low' %}
                            <span class="badge bg-success" title="Low Risk">üü¢ Low</span>
                            {% else %}
                            <span class="badge bg-secondary" title="Unknown Risk">‚ö™ Unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if sds.chemical_info.cas_numbers %}
                            <div class="small">
                                <div><strong>CAS:</strong> {{ sds.chemical_info.cas_numbers[0] }}</div>
                                {% if sds.chemical_info.cas_numbers|length > 1 %}
                                <div class="text-muted">+{{ sds.chemical_info.cas_numbers|length - 1 }} more</div>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted small">No CAS data</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="small text-center">
                                <div>
                                    <i class="bi bi-file-pdf text-danger"></i>
                                    {% if sds.file_size %}
                                    {{ "%.1f"|format(sds.file_size / 1024 / 1024) }}MB
                                    {% else %}
                                    Unknown
                                    {% endif %}
                                </div>
                                <div class="text-muted">{{ sds.estimated_pages }} pages</div>
                            </div>
                        </td>
                        <td>
                            {% if sds.created_date %}
                            {% set date = sds.created_date|int %}
                            {% set date_obj = moment(date * 1000) %}
                            <div class="small">
                                <div>{{ date_obj.format('MM/DD/YYYY') }}</div>
                                {% if sds.is_new %}
                                <div class="text-success">New</div>
                                {% elif sds.is_outdated %}
                                <div class="text-warning">Outdated</div>
                                {% else %}
                                <div class="text-muted">{{ date_obj.fromNow() }}</div>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a class="btn btn-outline-primary" href="/sds/{{ sds.id }}" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a class="btn btn-outline-success" href="/sds/{{ sds.id }}/download" title="Download PDF">
                                    <i class="bi bi-download"></i>
                                </a>
                                {% if sds.has_embeddings %}
                                <a class="btn btn-outline-info" href="/sds/{{ sds.id }}/chat" title="AI Chat">
                                    <i class="bi bi-robot"></i>
                                </a>
                                {% else %}
                                <button class="btn btn-outline-secondary" onclick="indexSDS('{{ sds.id }}')" title="Enable AI">
                                    <i class="bi bi-cpu"></i>
                                </button>
                                {% endif %}
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="showQR('{{ sds.id }}')">
                                            <i class="bi bi-qr-code"></i> QR Code
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="generateLabel('{{ sds.id }}')">
                                            <i class="bi bi-tag"></i> Generate Label
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="editSDS('{{ sds.id }}')">
                                            <i class="bi bi-pencil"></i> Edit Info
                                        </a></li>
                                        <li><a class="dropdown-item text-warning" href="#" onclick="archiveSDS('{{ sds.id }}')">
                                            <i class="bi bi-archive"></i> Archive
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center p-3 border-top">
            <div>
                <small class="text-muted">
                    Showing {{ sds_list|length }} of {{ sds_list|length }} records
                </small>
            </div>
            <div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">1</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-qr-code"></i> SDS QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer">
                    <div class="spinner-border" role="status"></div>
                </div>
                <div class="mt-3">
                    <p><strong id="qrProductName"></strong></p>
                    <p class="text-muted">Scan to access SDS on mobile device</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadQR()">
                    <i class="bi bi-download"></i> Download QR
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sdsData = {{ sds_list|tojson }};
    let filteredData = [...sdsData];
    
    // Quick search functionality
    document.getElementById('quickSearch').addEventListener('input', function() {
        const query = this.value.toLowerCase();
        applyFilters();
    });
    
    // Filter dropdowns
    ['departmentFilter', 'countryFilter', 'hazardFilter', 'aiStatusFilter', 'ageFilter'].forEach(id => {
        document.getElementById(id).addEventListener('change', applyFilters);
    });
    
    function applyFilters() {
        const search = document.getElementById('quickSearch').value.toLowerCase();
        const department = document.getElementById('departmentFilter').value;
        const country = document.getElementById('countryFilter').value;
        const hazard = document.getElementById('hazardFilter').value;
        const aiStatus = document.getElementById('aiStatusFilter').value;
        const age = document.getElementById('ageFilter').value;
        
        filteredData = sdsData.filter(sds => {
            // Search filter
            if (search && !searchMatches(sds, search)) return false;
            
            // Department filter
            if (department && sds.department !== department) return false;
            
            // Country filter
            if (country && sds.country !== country) return false;
            
            // Hazard filter
            if (hazard && sds.hazard_level !== hazard) return false;
            
            // AI status filter
            if (aiStatus === 'indexed' && !sds.has_embeddings) return false;
            if (aiStatus === 'not_indexed' && sds.has_embeddings) return false;
            
            // Age filter
            if (age === 'new' && !sds.is_new) return false;
            if (age === 'outdated' && !sds.is_outdated) return false;
            
            return true;
        });
        
        updateTable();
        updateStats();
    }
    
    function searchMatches(sds, query) {
        const searchFields = [
            sds.product_name,
            sds.manufacturer,
            sds.department,
            sds.country,
            ...(sds.chemical_info?.cas_numbers || [])
        ].join(' ').toLowerCase();
        
        return searchFields.includes(query);
    }
    
    function updateTable() {
        const tbody = document.getElementById('sdsTableBody');
        const rows = tbody.querySelectorAll('.sds-row');
        
        rows.forEach(row => {
            const sdsId = row.dataset.sdsId;
            const isVisible = filteredData.some(sds => sds.id === sdsId);
            row.style.display = isVisible ? '' : 'none';
        });
        
        document.getElementById('recordCount').textContent = filteredData.length;
    }
    
    function updateStats() {
        document.getElementById('totalSDS').textContent = filteredData.length;
        document.getElementById('aiIndexedSDS').textContent = 
            filteredData.filter(sds => sds.has_embeddings).length;
        document.getElementById('outdatedSDS').textContent = 
            filteredData.filter(sds => sds.is_outdated).length;
        document.getElementById('highHazardSDS').textContent = 
            filteredData.filter(sds => sds.hazard_level === 'high').length;
    }
    
    window.clearAllFilters = function() {
        document.getElementById('quickSearch').value = '';
        document.getElementById('departmentFilter').value = '';
        document.getElementById('countryFilter').value = '';
        document.getElementById('hazardFilter').value = '';
        document.getElementById('aiStatusFilter').value = '';
        document.getElementById('ageFilter').value = '';
        applyFilters();
    };
});

// SDS Action Functions
function showQR(sdsId) {
    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    const sds = {{ sds_list|tojson }}.find(item => item.id === sdsId);
    if (!sds) return;
    
    document.getElementById('qrProductName').textContent = sds.product_name;
    
    // Show QR code (simplified - you'd generate actual QR here)
    document.getElementById('qrCodeContainer').innerHTML = 
        `<div class="bg-light p-4 rounded"><i class="bi bi-qr-code" style="font-size: 4rem;"></i></div>`;
    
    modal.show();
}

function generateLabel(sdsId) {
    alert('Label generation feature - would open label designer modal');
}

function editSDS(sdsId) {
    window.location.href = `/sds/${sdsId}/edit`;
}

function archiveSDS(sdsId) {
    if (confirm('Archive this SDS? It will be moved to the archive.')) {
        // Archive functionality
        alert('SDS archived successfully');
    }
}

function indexSDS(sdsId) {
    if (confirm('Index this SDS for AI search? This may take a few minutes.')) {
        const button = event.target;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        button.disabled = true;
        
        // Simulate indexing
        setTimeout(() => {
            button.innerHTML = '<i class="bi bi-robot text-success"></i>';
            button.className = 'btn btn-outline-info';
            button.title = 'AI Chat';
            button.onclick = () => window.location.href = `/sds/${sdsId}/chat`;
        }, 2000);
    }
}

function toggleAllSelection(checkbox) {
    const checkboxes = document.querySelectorAll('.row-selector');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

function showBulkActions() {
    const selected = document.querySelectorAll('.row-selector:checked');
    if (selected.length === 0) {
        alert('Please select at least one SDS first');
        return;
    }
    alert(`Bulk actions for ${selected.length} selected SDS files`);
}

function showAnalytics() {
    alert('Analytics modal would open here');
}

function bulkAIIndex() {
    alert('Bulk AI indexing would start');
}

function exportAll() {
    alert('Export functionality would trigger');
}
</script>

<style>
.card h4 {
    font-size: 1.5rem;
    font-weight: 600;
}

.card small {
    font-size: 0.875rem;
    opacity: 0.9;
}

.progress {
    background-color: rgba(255, 255, 255, 0.3) !important;
}

.progress-bar {
    background-color: rgba(255, 255, 255, 0.8) !important;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.025);
}

.badge {
    font-size: 0.75rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.dropdown-menu {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }
    
    .card h4 {
        font-size: 1.25rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .row > .col-md-2 {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}
