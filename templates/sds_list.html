{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-file-earmark-text text-success"></i> SDS Library</h3>
    <div>
        <a href="{{ url_for('sds.sds_upload') }}" class="btn btn-primary">
            <i class="bi bi-cloud-upload"></i> Upload SDS
        </a>
        <div class="btn-group ms-2" role="group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i> Tools
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="showBulkUpload()">
                    <i class="bi bi-upload"></i> Bulk Upload (ZIP)
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="exportCSV()">
                    <i class="bi bi-filetype-csv"></i> Export CSV
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="reindexAll()">
                    <i class="bi bi-cpu"></i> Rebuild AI Index
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row g-3 mb-3">
    <div class="col-md-3">
        <label class="form-label">Department</label>
        <input type="text" id="filterDepartment" class="form-control" placeholder="e.g., Lab, Production">
    </div>
    <div class="col-md-3">
        <label class="form-label">Manufacturer</label>
        <input type="text" id="filterManufacturer" class="form-control" placeholder="e.g., Acme Chemicals">
    </div>
    <div class="col-md-3">
        <label class="form-label">Country</label>
        <input type="text" id="filterCountry" class="form-control" placeholder="e.g., Canada">
    </div>
    <div class="col-md-3">
        <label class="form-label">State/Province</label>
        <input type="text" id="filterState" class="form-control" placeholder="e.g., Ontario">
    </div>
</div>

<!-- Dynamic table -->
<div class="card">
    <div class="card-body">
        {% include "components/dynamic_table.html" %}
        <div id="sdsTable"></div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="sdsPreviewModal" tabindex="-1" aria-labelledby="sdsPreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-eye me-2"></i>View SDS</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="sdsPreviewBody">
        <div class="text-center text-muted py-5">Loading…</div>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Upload Modal -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="bulkUploadForm" enctype="multipart/form-data" method="post" action="{{ url_for('sds.sds_bulk_upload') }}">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-upload me-2"></i>Bulk Upload (ZIP)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Upload a .zip containing multiple SDS PDF files.</p>
        <input class="form-control" type="file" name="zip_file" accept=".zip" required>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Upload</button>
      </div>
    </form>
  </div>
</div>

<script>
    // SDS data from server
    const sdsData = {{ rows|tojson }};

    // Enhanced column configuration
    const sdsColumns = [
        {
            key: 'id',
            label: 'SDS ID',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value) => `<code>${value}</code>`
        },
        {
            key: 'product_name',
            label: 'Product Name',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) => {
                const hasAI = row.has_embeddings ? 
                    '<i class="bi bi-robot text-primary ms-1" title="AI Searchable"></i>' : '';
                return `<strong>${value}</strong>${hasAI}`;
            }
        },

        /* ▼▼▼ NEW COLUMNS (Department, State, Country, Manufacturer) ▼▼▼ */
        {
            key: 'department',
            label: 'Department',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) =>
                row.department ? `<span>${row.department}</span>` : '<span class="text-muted">—</span>'
        },
        {
            key: 'state',
            label: 'State',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) =>
                row.state ? `<span>${row.state}</span>` : '<span class="text-muted">—</span>'
        },
        {
            key: 'country',
            label: 'Country',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) =>
                row.country ? `<span>${row.country}</span>` : '<span class="text-muted">—</span>'
        },
        {
            key: 'manufacturer',
            label: 'Manufacturer',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) =>
                row.manufacturer ? `<span>${row.manufacturer}</span>` : '<span class="text-muted">—</span>'
        },
        /* ▲▲▲ END NEW COLUMNS ▲▲▲ */

        {
            key: 'chemical_info',
            label: 'CAS Numbers',
            type: 'custom',
            filterable: true,
            sortable: false,
            format: (value) => {
                if (!value || !value.cas_numbers || value.cas_numbers.length === 0) {
                    return '<span class="text-muted">No CAS</span>';
                }
                const displayCAS = value.cas_numbers.slice(0, 2).map(cas =>
                    `<span class="badge bg-light text-dark">${cas}</span>`
                ).join(' ');
                const extra = value.cas_numbers.length > 2 ?
                    ` <small class="text-muted">+${value.cas_numbers.length - 2} more</small>` : '';
                return displayCAS + extra;
            }
        },
        {
            key: 'file_name',
            label: 'File',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) => {
                const size = row.file_size ?
                    ` <small class="text-muted">(${(row.file_size / 1024 / 1024).toFixed(1)}MB)</small>` : '';
                return `${value}${size}`;
            }
        },
        {
            key: 'processing_metadata',
            label: 'Processing',
            type: 'custom',
            filterable: false,
            sortable: false,
            format: (value, row) => {
                const chunks = value?.chunks_count || 0;
                const hasEmbeddings = row.has_embeddings;
                const tables = value?.tables_extracted || 0;

                return `
                    <div class="small">
                        <div>${chunks} chunks ${hasEmbeddings ? '✓' : '✗'} AI</div>
                        <div class="text-muted">${tables} tables extracted</div>
                    </div>
                `;
            }
        },
        {
            key: 'chemical_info.hazard_statements',
            label: 'Hazards',
            type: 'custom',
            filterable: false,
            sortable: false,
            format: (value, row) => {
                const hazards = row.chemical_info?.hazard_statements || [];
                if (hazards.length === 0) return '<span class="text-muted">None listed</span>';

                const displayHazards = hazards.slice(0, 2).map(h => {
                    const hCode = h.match(/H\d{3}/)?.[0] || '';
                    return `<span class="badge bg-danger-subtle text-danger border me-1">${hCode || h}</span>`;
                }).join(' ');
                const extra = hazards.length > 2 ?
                    ` <small class="text-muted">+${hazards.length - 2}</small>` : '';
                return displayHazards + extra;
            }
        },
        {
            key: 'actions',
            label: 'Actions',
            type: 'custom',
            filterable: false,
            sortable: false,
            format: (value, row) => `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-primary" onclick="previewSDS('${row.id}')" title="View">
                        <i class="bi bi-eye"></i>
                    </button>
                    <a class="btn btn-outline-secondary" href="/sds/${row.id}/download" title="Download">
                        <i class="bi bi-download"></i>
                    </a>
                    ${row.has_embeddings ? `
                        <a class="btn btn-outline-info" href="/sds/${row.id}/chat" title="AI Chat">
                            <i class="bi bi-robot"></i>
                        </a>
                    ` : ''}
                    <a class="btn btn-outline-success" href="/sds/${row.id}/qr" title="QR Code">
                        <i class="bi bi-qr-code"></i>
                    </a>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/sds/${row.id}/label">
                                <i class="bi bi-tag"></i> Generate Label
                            </a></li>
                            <li><a class="dropdown-item" href="/sds/${row.id}">
                                <i class="bi bi-info-circle"></i> Details
                            </a></li>
                        </ul>
                    </div>
                </div>
            `
        }
    ];

    // Mount table
    const table = new DynamicTable({
        el: document.getElementById('sdsTable'),
        data: sdsData,
        columns: sdsColumns
    });

    // Quick search (kept as-is)
    const qsInput = document.getElementById('quickSearch');
    if (qsInput) {
        qsInput.addEventListener('input', () => {
            table.setQuickFilter(qsInput.value);
        });
    }

    // Field-specific filters (new but non-invasive)
    const fDept = document.getElementById('filterDepartment');
    const fManu = document.getElementById('filterManufacturer');
    const fCountry = document.getElementById('filterCountry');
    const fState = document.getElementById('filterState');

    function applyFieldFilters() {
        const dept = (fDept?.value || '').toLowerCase();
        const manu = (fManu?.value || '').toLowerCase();
        const country = (fCountry?.value || '').toLowerCase();
        const state = (fState?.value || '').toLowerCase();

        table.setRowFilter((row) => {
            const okDept = !dept || (row.department || '').toLowerCase().includes(dept);
            const okManu = !manu || (row.manufacturer || '').toLowerCase().includes(manu);
            const okCountry = !country || (row.country || '').toLowerCase().includes(country);
            const okState = !state || (row.state || '').toLowerCase().includes(state);
            return okDept && okManu && okCountry && okState;
        });
    }

    [fDept, fManu, fCountry, fState].forEach(input => {
        if (input) input.addEventListener('input', applyFieldFilters);
    });

    // Preview (View) handler — unchanged
    function previewSDS(id) {
        const modal = new bootstrap.Modal(document.getElementById('sdsPreviewModal'));
        const body = document.getElementById('sdsPreviewBody');
        body.innerHTML = `<div class="text-center text-muted py-5">Loading…</div>`;
        modal.show();
        fetch(`/sds/${id}/view_inline`)
          .then(r => r.ok ? r.text() : '<div class="text-danger p-3">Failed to load preview.</div>')
          .then(html => { body.innerHTML = html; })
          .catch(() => { body.innerHTML = '<div class="text-danger p-3">Failed to load preview.</div>'; });
    }

    // Bulk upload modal opener
    function showBulkUpload() {
        new bootstrap.Modal(document.getElementById('bulkUploadModal')).show();
    }

    // CSV export (kept simple)
    function exportCSV() {
        window.location.href = '{{ url_for("sds.sds_export_csv") }}';
    }

    // Reindex all (kept as-is placeholder)
    function reindexAll() {
        if (!confirm('Rebuild AI index for all SDS?')) return;
        fetch('{{ url_for("sds.sds_reindex_all") }}', { method: 'POST' })
            .then(r => r.ok ? location.reload() : alert('Failed to start reindex.'))
            .catch(() => alert('Network error.'));
    }
</script>

<!-- Quick Search (kept near bottom to match your original layout) -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="quickSearch" 
                   placeholder="Search by product name, CAS number, or chemical...">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="hazardFilter">
            <option value="">All Hazard Types</option>
            <option value="flammable">Flammable</option>
            <option value="toxic">Toxic</option>
            <option value="corrosive">Corrosive</option>
            <option value="oxidizing">Oxidizing</option>
            <option value="harmful">Harmful/Irritant</option>
        </select>
    </div>
    <div class="col-md-3 text-end">
        <a href="{{ url_for('sds.sds_upload') }}" class="btn btn-outline-primary">
            <i class="bi bi-plus-circle"></i> Add SDS
        </a>
    </div>
</div>
{% endblock %}
