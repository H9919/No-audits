{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-exclamation-triangle text-warning"></i> Incidents</h3>
    <div>
        <a class="btn btn-primary" href="{{ url_for('incidents.new_incident') }}">
            <i class="bi bi-plus-circle"></i> New Incident
        </a>
        <div class="btn-group ms-2" role="group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i> Options
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="showBulkActions()">
                    <i class="bi bi-check2-square"></i> Bulk Actions
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="showAnalytics()">
                    <i class="bi bi-graph-up"></i> Analytics
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="exportAll()">
                    <i class="bi bi-download"></i> Export All
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Quick Stats Dashboard -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 id="totalIncidents">{{ rows|length }}</h4>
                <small>Total Incidents</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 id="openIncidents">{{ rows|selectattr("status", "equalto", "draft")|list|length }}</h4>
                <small>Open/Draft</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 id="completeIncidents">{{ rows|selectattr("status", "equalto", "complete")|list|length }}</h4>
                <small>Complete</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 id="avgCompleteness">{{ ((rows|map(attribute="completeness")|sum) / (rows|length))|round|int if rows|length > 0 else 0 }}%</h4>
                <small>Avg Completeness</small>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Dynamic Table -->
<div id="incidentsTableContainer">
    <!-- This will be populated by the dynamic table component -->
</div>

<!-- Include the dynamic table component -->
{% set table_id = 'incidents' %}
{% set table_title = 'Incidents Management' %}
{% include 'components/dynamic_table.html' %}

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Action</label>
                    <select class="form-select" id="bulkActionSelect">
                        <option value="">Choose action...</option>
                        <option value="export">Export Selected</option>
                        <option value="assign">Assign Investigator</option>
                        <option value="status">Change Status</option>
                        <option value="priority">Set Priority</option>
                    </select>
                </div>
                <div id="bulkActionOptions" class="d-none">
                    <!-- Options will be populated based on selected action -->
                </div>
                <div class="alert alert-info">
                    <span id="selectedCount">0</span> incidents selected
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkAction()">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Incidents Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="incidentTypeChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="completenessChart"></canvas>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Define incidents data structure
    const incidentsData = {{ rows|tojson }};
    
    // Define column configuration
    const incidentsColumns = [
        {
            key: 'id',
            label: 'Incident ID',
            type: 'code',
            filterable: true,
            sortable: true
        },
        {
            key: 'type',
            label: 'Type',
            type: 'badge',
            filterable: true,
            sortable: true,
            badgeMap: {
                'injury': 'danger',
                'environmental': 'warning',
                'vehicle': 'info',
                'security': 'dark',
                'property': 'secondary',
                'near_miss': 'primary',
                'other': 'light'
            }
        },
        {
            key: 'status',
            label: 'Status',
            type: 'badge',
            filterable: true,
            sortable: true,
            badgeMap: {
                'complete': 'success',
                'incomplete': 'warning',
                'draft': 'secondary'
            }
        },
        {
            key: 'completeness',
            label: 'Completeness',
            type: 'progress',
            filterable: true,
            sortable: true,
            format: (value) => `${value}%`
        },
        {
            key: 'created_ts',
            label: 'Created Date',
            type: 'date',
            filterable: true,
            sortable: true
        },
        {
            key: 'facility_code',
            label: 'Facility',
            type: 'text',
            filterable: true,
            sortable: true
        },
        {
            key: 'region',
            label: 'Region',
            type: 'text',
            filterable: true,
            sortable: true
        },
        {
            key: 'anonymous',
            label: 'Reporter',
            type: 'custom',
            filterable: true,
            sortable: false,
            format: (value, row) => row.anonymous ? 
                '<span class="text-muted">Anonymous</span>' : 
                '<span class="text-success">Identified</span>'
        },
        {
            key: 'actions',
            label: 'Actions',
            type: 'custom',
            filterable: false,
            sortable: false,
            format: (value, row) => `
                <div class="btn-group btn-group-sm">
                    <a class="btn btn-outline-primary" href="/incidents/${row.id}/edit" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a class="btn btn-outline-secondary" href="/incidents/${row.id}/pdf" title="Download PDF">
                        <i class="bi bi-file-pdf"></i>
                    </a>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/incidents/${row.id}/capa">
                                <i class="bi bi-arrow-repeat"></i> Create CAPA
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="duplicateIncident('${row.id}')">
                                <i class="bi bi-copy"></i> Duplicate
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="archiveIncident('${row.id}')">
                                <i class="bi bi-archive"></i> Archive
                            </a></li>
                        </ul>
                    </div>
                </div>
            `
        }
    ];
    
    // Initialize the dynamic table
    const table = initTable('incidents', incidentsData, incidentsColumns, {
        sortable: true,
        filterable: true,
        paginated: true,
        exportable: true,
        persistPreferences: true,
        selectable: true
    });
    
    // Setup custom formatting for progress bars
    table.formatCellValue = function(value, column) {
        if (column.type === 'progress') {
            const percentage = parseInt(value) || 0;
            const colorClass = percentage >= 80 ? 'success' : percentage >= 50 ? 'warning' : 'danger';
            return `
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 20px;">
                        <div class="progress-bar bg-${colorClass}" style="width: ${percentage}%"></div>
                    </div>
                    <small class="text-muted">${percentage}%</small>
                </div>
            `;
        } else if (column.type === 'custom' && column.format) {
            return column.format(value, this.getCurrentRowData());
        } else {
            return this.constructor.prototype.formatCellValue.call(this, value, column);
        }
    };
    
    // Add row selection functionality
    let selectedRows = new Set();
    
    window.selectRow = function(tableId, rowId) {
        const row = event.currentTarget;
        const checkbox = row.querySelector('.row-selector');
        
        if (selectedRows.has(rowId)) {
            selectedRows.delete(rowId);
            row.classList.remove('table-row-highlight');
            if (checkbox) checkbox.checked = false;
        } else {
            selectedRows.add(rowId);
            row.classList.add('table-row-highlight');
            if (checkbox) checkbox.checked = true;
        }
        
        updateSelectedCount();
    };
    
    function updateSelectedCount() {
        const count = selectedRows.size;
        document.getElementById('selectedCount').textContent = count;
        
        // Update bulk actions button state
        const bulkBtn = document.querySelector('[onclick="showBulkActions()"]');
        if (bulkBtn) {
            bulkBtn.classList.toggle('btn-primary', count > 0);
            bulkBtn.classList.toggle('btn-outline-secondary', count === 0);
        }
    }
    
    // Enhanced search functionality
    const originalApplyFilters = table.applyFilters.bind(table);
    table.applyFilters = function() {
        originalApplyFilters();
        updateStats();
    };
    
    function updateStats() {
        const filtered = table.filteredData;
        document.getElementById('totalIncidents').textContent = filtered.length;
        document.getElementById('openIncidents').textContent = 
            filtered.filter(item => item.status === 'draft').length;
        document.getElementById('completeIncidents').textContent = 
            filtered.filter(item => item.status === 'complete').length;
        
        const avgCompleteness = filtered.length > 0 ? 
            Math.round(filtered.reduce((sum, item) => sum + (item.completeness || 0), 0) / filtered.length) : 0;
        document.getElementById('avgCompleteness').textContent = avgCompleteness + '%';
    }
});

// Bulk Actions
function showBulkActions() {
    const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
    modal.show();
}

function executeBulkAction() {
    const action = document.getElementById('bulkActionSelect').value;
    const selectedIds = Array.from(selectedRows);
    
    if (!action || selectedIds.length === 0) {
        alert('Please select an action and at least one incident.');
        return;
    }
    
    // Implement bulk action logic here
    console.log('Executing bulk action:', action, 'on incidents:', selectedIds);
    
    // Close modal and refresh table
    bootstrap.Modal.getInstance(document.getElementById('bulkActionsModal')).hide();
}

// Analytics
function showAnalytics() {
    const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
    modal.show();
    
    // Generate charts after modal is shown
    setTimeout(() => {
        generateAnalyticsCharts();
    }, 300);
}

function generateAnalyticsCharts() {
    const data = tableInstances['incidents'].data;
    
    // Incident Type Chart
    const typeCtx = document.getElementById('incidentTypeChart').getContext('2d');
    const typeCounts = {};
    data.forEach(incident => {
        typeCounts[incident.type] = (typeCounts[incident.type] || 0) + 1;
    });
    
    new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(typeCounts),
            datasets: [{
                data: Object.values(typeCounts),
                backgroundColor: [
                    '#dc3545', '#fd7e14', '#ffc107', '#198754', 
                    '#0dcaf0', '#6f42c1', '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Incidents by Type'
                }
            }
        }
    });
    
    // Completeness Distribution Chart
    const compCtx = document.getElementById('completenessChart').getContext('2d');
    const completenessRanges = { '0-25%': 0, '26-50%': 0, '51-75%': 0, '76-100%': 0 };
    data.forEach(incident => {
        const comp = incident.completeness || 0;
        if (comp <= 25) completenessRanges['0-25%']++;
        else if (comp <= 50) completenessRanges['26-50%']++;
        else if (comp <= 75) completenessRanges['51-75%']++;
        else completenessRanges['76-100%']++;
    });
    
    new Chart(compCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(completenessRanges),
            datasets: [{
                label: 'Number of Incidents',
                data: Object.values(completenessRanges),
                backgroundColor: '#0dcaf0'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Completeness Distribution'
                }
            }
        }
    });
}

// Additional Functions
function duplicateIncident(incidentId) {
    if (confirm('Create a copy of this incident?')) {
        // Implement duplication logic
        console.log('Duplicating incident:', incidentId);
    }
}

function archiveIncident(incidentId) {
    if (confirm('Archive this incident? This action can be undone.')) {
        // Implement archiving logic
        console.log('Archiving incident:', incidentId);
    }
}

function exportAll() {
    tableInstances['incidents']?.export();
}
</script>

<style>
.progress {
    background-color: #e9ecef !important;
}

.table-row-highlight {
    background-color: rgba(13, 202, 240, 0.1) !important;
}

.btn-group .dropdown-toggle::after {
    margin-left: 0.255em;
}

.card h4 {
    font-size: 1.5rem;
    font-weight: 600;
}

.card small {
    font-size: 0.875rem;
    opacity: 0.9;
}

@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }
}
</style>
{% endblock %}
