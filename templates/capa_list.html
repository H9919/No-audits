{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-arrow-repeat text-primary"></i> Corrective & Preventive Actions (CAPA)</h3>
    <div>
        <a href="{{ url_for('capa.new_capa') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> New CAPA
        </a>
        <a href="{{ url_for('capa.capa_dashboard') }}" class="btn btn-info">
            <i class="bi bi-graph-up"></i> Dashboard
        </a>
        <div class="btn-group ms-2" role="group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i> More
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('capa.assigned_capas') }}">
                    <i class="bi bi-person-gear"></i> My CAPAs
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="showOverdueAlert()">
                    <i class="bi bi-exclamation-triangle"></i> Overdue Alert
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="bulkAssign()">
                    <i class="bi bi-people"></i> Bulk Assign
                </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Enhanced Stats Cards with Real-time Updates -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center bg-primary text-white">
            <div class="card-body">
                <h4 id="openCapas">{{ capas|selectattr("status", "equalto", "open")|list|length }}</h4>
                <small>Open CAPAs</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((capas|selectattr('status', 'equalto', 'open')|list|length) / (capas|length) * 100) if capas|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-warning text-white">
            <div class="card-body">
                <h4 id="inProgressCapas">{{ capas|selectattr("status", "equalto", "in_progress")|list|length }}</h4>
                <small>In Progress</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((capas|selectattr('status', 'equalto', 'in_progress')|list|length) / (capas|length) * 100) if capas|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-success text-white">
            <div class="card-body">
                <h4 id="completedCapas">{{ capas|selectattr("status", "equalto", "completed")|list|length }}</h4>
                <small>Completed</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" style="width: {{ ((capas|selectattr('status', 'equalto', 'completed')|list|length) / (capas|length) * 100) if capas|length > 0 else 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-danger text-white">
            <div class="card-body">
                <h4 id="overdueCapas">-</h4>
                <small>Overdue</small>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar bg-light" id="overdueProgress" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filters Section -->
<div class="card mb-4" id="advancedFilters" style="display: none;">
    <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-funnel"></i> Advanced Filters</h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Source Type</label>
                <select class="form-select" id="sourceFilter">
                    <option value="">All Sources</option>
                    <option value="incident">Incident</option>
                    <option value="audit">Audit</option>
                    <option value="risk">Risk Assessment</option>
                    <option value="manual">Manual</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Due Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="dueDateFrom">
                    <input type="date" class="form-control" id="dueDateTo">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Assignee</label>
                <select class="form-select" id="assigneeFilter">
                    <option value="">All Assignees</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Created Date</label>
                <select class="form-select" id="createdDateFilter">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Main CAPA Table -->
<div id="capaTableContainer">
    <!-- Dynamic table will be rendered here -->
</div>

<!-- Include the dynamic table component -->
{% set table_id = 'capas' %}
{% set table_title = 'CAPAs Management' %}
{% include 'components/dynamic_table.html' %}

<!-- Quick Action Modals -->
<div class="modal fade" id="quickUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Update CAPA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickUpdateForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">New Status</label>
                        <select class="form-select" name="status" id="quickStatus">
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comment</label>
                        <textarea class="form-control" name="comment" rows="3" placeholder="Add a comment about this update"></textarea>
                    </div>
                    <input type="hidden" name="capa_id" id="quickCapaId">
                    <input type="hidden" name="updated_by" value="Current User">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update CAPA</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="overdueAlertModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Overdue CAPAs Alert</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="overdueCapasList">
                    <!-- Populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="sendOverdueNotifications()">
                    <i class="bi bi-envelope"></i> Send Notifications
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // CAPA data from server
    const capasData = {{ capas|tojson }};
    
    // Enhanced column configuration with custom formatting
    const capaColumns = [
        {
            key: 'id',
            label: 'CAPA ID',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value) => `<code>${value.substring(0, 8)}</code>`
        },
        {
            key: 'title',
            label: 'Title',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) => {
                const truncated = value.length > 50 ? value.substring(0, 50) + '...' : value;
                return `
                    <div>
                        <strong>${truncated}</strong>
                        ${row.description ? `<br><small class="text-muted">${row.description.substring(0, 80)}${row.description.length > 80 ? '...' : ''}</small>` : ''}
                    </div>
                `;
            }
        },
        {
            key: 'type',
            label: 'Type',
            type: 'badge',
            filterable: true,
            sortable: true,
            badgeMap: {
                'corrective': 'warning',
                'preventive': 'success'
            }
        },
        {
            key: 'assignee',
            label: 'Assignee',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value) => value || '<span class="text-muted">Unassigned</span>'
        },
        {
            key: 'due_date',
            label: 'Due Date',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) => {
                if (!value) return '<span class="text-muted">No due date</span>';
                
                const dueDate = new Date(value);
                const today = new Date();
                const isOverdue = dueDate < today && ['open', 'in_progress'].includes(row.status);
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let badge = '';
                if (isOverdue) {
                    badge = `<br><small class="badge bg-danger">Overdue ${Math.abs(daysDiff)} days</small>`;
                } else if (daysDiff <= 7 && daysDiff > 0) {
                    badge = `<br><small class="badge bg-warning">Due in ${daysDiff} days</small>`;
                }
                
                return `${dueDate.toLocaleDateString()}${badge}`;
            }
        },
        {
            key: 'priority',
            label: 'Priority',
            type: 'badge',
            filterable: true,
            sortable: true,
            badgeMap: {
                'critical': 'danger',
                'high': 'warning',
                'medium': 'info',
                'low': 'secondary'
            }
        },
        {
            key: 'status',
            label: 'Status',
            type: 'badge',
            filterable: true,
            sortable: true,
            badgeMap: {
                'completed': 'success',
                'in_progress': 'warning',
                'open': 'secondary'
            }
        },
        {
            key: 'source',
            label: 'Source',
            type: 'custom',
            filterable: true,
            sortable: true,
            format: (value, row) => {
                if (value !== 'manual') {
                    return `
                        <div>
                            <span class="badge bg-info">${value.charAt(0).toUpperCase() + value.slice(1)}</span>
                            ${row.source_id ? `<br><small class="text-muted">${row.source_id.substring(0, 8)}</small>` : ''}
                        </div>
                    `;
                }
                return '<span class="text-muted">Manual</span>';
            }
        },
        {
            key: 'created_date',
            label: 'Created',
            type: 'date',
            filterable: true,
            sortable: true
        },
        {
            key: 'actions',
            label: 'Actions',
            type: 'custom',
            filterable: false,
            sortable: false,
            format: (value, row) => `
                <div class="btn-group btn-group-sm">
                    <a href="/capa/${row.id}" class="btn btn-outline-primary" title="View Details">
                        <i class="bi bi-eye"></i>
                    </a>
                    ${row.status !== 'completed' ? `
                        <button class="btn btn-outline-success" onclick="quickUpdate('${row.id}', 'completed')" title="Mark Complete">
                            <i class="bi bi-check"></i>
                        </button>
                    ` : ''}
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            ${row.status === 'open' ? `
                                <li><a class="dropdown-item" href="#" onclick="quickUpdate('${row.id}', 'in_progress')">
                                    <i class="bi bi-play"></i> Start Progress
                                </a></li>
                            ` : ''}
                            <li><a class="dropdown-item" href="#" onclick="reassignCapa('${row.id}')">
                                <i class="bi bi-person-gear"></i> Reassign
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="extendDueDate('${row.id}')">
                                <i class="bi bi-calendar-plus"></i> Extend Due Date
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="duplicateCapa('${row.id}')">
                                <i class="bi bi-copy"></i> Duplicate
                            </a></li>
                        </ul>
                    </div>
                </div>
            `
        }
    ];
    
    // Initialize the dynamic table
    const table = initTable('capas', capasData, capaColumns, {
        sortable: true,
        filterable: true,
        paginated: true,
        exportable: true,
        persistPreferences: true,
        defaultSort: { column: 'due_date', direction: 'asc' }
    });
    
    // Load overdue count from API
    loadCapaStats();
    
    // Setup advanced filters
    setupAdvancedFilters();
    
    // Setup auto-refresh for real-time updates
    setInterval(loadCapaStats, 300000); // Refresh every 5 minutes
    
    // Setup assignee filter options
    populateAssigneeFilter();
});

function loadCapaStats() {
    fetch('/capa/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('overdueCapas').textContent = data.overdue || 0;
            
            // Update progress bar
            const total = data.total || 1;
            const overduePercent = ((data.overdue || 0) / total) * 100;
            document.getElementById('overdueProgress').style.width = overduePercent + '%';
            
            // Update other stats if available
            if (data.open !== undefined) {
                document.getElementById('openCapas').textContent = data.open;
            }
            if (data.in_progress !== undefined) {
                document.getElementById('inProgressCapas').textContent = data.in_progress;
            }
            if (data.completed !== undefined) {
                document.getElementById('completedCapas').textContent = data.completed;
            }
        })
        .catch(error => {
            console.error('Error loading CAPA stats:', error);
            document.getElementById('overdueCapas').textContent = '?';
        });
}

function setupAdvancedFilters() {
    // Add event listeners for advanced filters
    ['sourceFilter', 'dueDateFrom', 'dueDateTo', 'assigneeFilter', 'createdDateFilter'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', applyAdvancedFilters);
        }
    });
}

function populateAssigneeFilter() {
    const assignees = [...new Set(capasData.map(capa => capa.assignee).filter(Boolean))];
    const select = document.getElementById('assigneeFilter');
    
    assignees.forEach(assignee => {
        const option = document.createElement('option');
        option.value = assignee;
        option.textContent = assignee;
        select.appendChild(option);
    });
}

function applyAdvancedFilters() {
    const table = tableInstances['capas'];
    if (!table) return;
    
    const sourceFilter = document.getElementById('sourceFilter').value;
    const dueDateFrom = document.getElementById('dueDateFrom').value;
    const dueDateTo = document.getElementById('dueDateTo').value;
    const assigneeFilter = document.getElementById('assigneeFilter').value;
    const createdDateFilter = document.getElementById('createdDateFilter').value;
    
    let filteredData = [...table.data];
    
    // Apply source filter
    if (sourceFilter) {
        filteredData = filteredData.filter(item => item.source === sourceFilter);
    }
    
    // Apply assignee filter
    if (assigneeFilter) {
        filteredData = filteredData.filter(item => item.assignee === assigneeFilter);
    }
    
    // Apply due date range filter
    if (dueDateFrom || dueDateTo) {
        filteredData = filteredData.filter(item => {
            if (!item.due_date) return false;
            const dueDate = new Date(item.due_date);
            const fromDate = dueDateFrom ? new Date(dueDateFrom) : new Date('1900-01-01');
            const toDate = dueDateTo ? new Date(dueDateTo) : new Date('2100-01-01');
            return dueDate >= fromDate && dueDate <= toDate;
        });
    }
    
    // Apply created date filter
    if (createdDateFilter) {
        const now = new Date();
        let cutoffDate = new Date();
        
        switch (createdDateFilter) {
            case 'today':
                cutoffDate.setHours(0, 0, 0, 0);
                break;
            case 'week':
                cutoffDate.setDate(now.getDate() - 7);
                break;
            case 'month':
                cutoffDate.setMonth(now.getMonth() - 1);
                break;
            case 'quarter':
                cutoffDate.setMonth(now.getMonth() - 3);
                break;
            case 'year':
                cutoffDate.setFullYear(now.getFullYear() - 1);
                break;
        }
        
        filteredData = filteredData.filter(item => {
            const createdDate = new Date(item.created_date);
            return createdDate >= cutoffDate;
        });
    }
    
    table.filteredData = filteredData;
    table.currentPage = 1;
    table.render();
}

function toggleAdvancedFilters() {
    const panel = document.getElementById('advancedFilters');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// Quick Actions
function quickUpdate(capaId, status) {
    document.getElementById('quickCapaId').value = capaId;
    document.getElementById('quickStatus').value = status;
    
    const modal = new bootstrap.Modal(document.getElementById('quickUpdateModal'));
    modal.show();
}

function reassignCapa(capaId) {
    const newAssignee = prompt('Enter new assignee name:');
    if (newAssignee) {
        updateCapa(capaId, {
            assignee: newAssignee,
            comment: `Reassigned to ${newAssignee}`,
            updated_by: 'Current User'
        });
    }
}

function extendDueDate(capaId) {
    const newDueDate = prompt('Enter new due date (YYYY-MM-DD):');
    if (newDueDate && /^\d{4}-\d{2}-\d{2}$/.test(newDueDate)) {
        updateCapa(capaId, {
            due_date: newDueDate,
            comment: `Due date extended to ${newDueDate}`,
            updated_by: 'Current User'
        });
    } else if (newDueDate) {
        alert('Please enter a valid date in YYYY-MM-DD format');
    }
}

function duplicateCapa(capaId) {
    if (confirm('Create a duplicate of this CAPA?')) {
        // Implementation for duplicating CAPA
        console.log('Duplicating CAPA:', capaId);
    }
}

function updateCapa(capaId, data) {
    const formData = new FormData();
    Object.keys(data).forEach(key => {
        formData.append(key, data[key]);
    });
    
    fetch(`/capa/${capaId}/update`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error updating CAPA');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating CAPA');
    });
}

// Handle quick update form submission
document.getElementById('quickUpdateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const capaId = formData.get('capa_id');
    
    updateCapa(capaId, Object.fromEntries(formData));
});

// Overdue Alert System
function showOverdueAlert() {
    loadOverdueCapas();
    const modal = new bootstrap.Modal(document.getElementById('overdueAlertModal'));
    modal.show();
}

function loadOverdueCapas() {
    const today = new Date();
    const overdueCapas = capasData.filter(capa => {
        if (!capa.due_date || capa.status === 'completed') return false;
        const dueDate = new Date(capa.due_date);
        return dueDate < today;
    });
    
    const container = document.getElementById('overdueCapasList');
    
    if (overdueCapas.length === 0) {
        container.innerHTML = '<div class="alert alert-success">No overdue CAPAs found!</div>';
        return;
    }
    
    container.innerHTML = overdueCapas.map(capa => {
        const daysPast = Math.ceil((today - new Date(capa.due_date)) / (1000 * 60 * 60 * 24));
        return `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${capa.title}</h6>
                            <p class="mb-1 text-muted small">${capa.description || 'No description'}</p>
                            <div>
                                <span class="badge bg-${capa.priority === 'critical' ? 'danger' : 'warning'}">${capa.priority}</span>
                                <span class="badge bg-secondary">${capa.assignee || 'Unassigned'}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-danger">${daysPast} days overdue</span>
                            <br><small class="text-muted">Due: ${new Date(capa.due_date).toLocaleDateString()}</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function sendOverdueNotifications() {
    // Implementation for sending notifications
    alert('Overdue notifications would be sent to assignees and managers.');
    bootstrap.Modal.getInstance(document.getElementById('overdueAlertModal')).hide();
}

function bulkAssign() {
    // Implementation for bulk assignment
    alert('Bulk assignment feature would be implemented here.');
}

// Global functions for table interactions
window.quickUpdate = quickUpdate;
window.reassignCapa = reassignCapa;
window.extendDueDate = extendDueDate;
window.duplicateCapa = duplicateCapa;
</script>

<style>
.card h4 {
    font-size: 1.5rem;
    font-weight: 600;
}

.card small {
    font-size: 0.875rem;
    opacity: 0.9;
}

.progress {
    background-color: rgba(255, 255, 255, 0.3) !important;
}

.progress-bar {
    background-color: rgba(255, 255, 255, 0.8) !important;
}

.badge {
    font-size: 0.75rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.025);
}

.dropdown-menu {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

#overdueCapasList .card {
    border-left: 4px solid #dc3545;
}

@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }
    
    .card h4 {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}
