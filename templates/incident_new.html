{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">New Incident</h3>

<form method="post" class="card p-3" id="avomo-form">
  <!-- Basic Information (Q1–Q5) -->
  <div class="mb-3">
    <label class="form-label">Event Date <span class="text-danger">*</span></label>
    <input type="date" class="form-control" name="event_date" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Event Time (HHMM, e.g., 2345) <span class="text-danger">*</span></label>
    <input type="text" class="form-control" name="event_time" pattern="^\\d{3,4}$" placeholder="e.g., 0915" required>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">Name</label>
      <input type="text" class="form-control" name="reporter_name" placeholder="(optional)">
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label">E-mail</label>
      <input type="email" class="form-control" name="reporter_email" placeholder="(optional)">
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">Site <span class="text-danger">*</span></label>
    <input class="form-control" name="site" list="site-examples" required>
    <datalist id="site-examples">
      <option value="Austin Stassney"><option value="Atlanta Plymouth"><option value="Atlanta Manheim">
    </datalist>
  </div>

  <!-- Q6 Severe criteria BEFORE Q7 Event Type -->
  <div class="mb-3">
    <label class="form-label">Does the event meet the severe event criteria? <span class="text-danger">*</span></label>
    <select class="form-select" name="severe_event_flag" id="severe_event_flag" required>
      <option value="">Select…</option>
      <option value="yes">Yes - This is a high severity event</option>
      <option value="no">No - This is not a high severity event</option>
    </select>
    <div class="form-text">
      Answer “Yes” only if it relates to current operations/system configuration and could lead to (or caused): AV collision with 911 call or frame/internal damage; fatality/hospitalization/amputation/loss of eye; site-wide emergency (911); physical/cybersecurity breach; outage &gt; 15 minutes; chemical spill &gt; 1 gallon.
    </div>
  </div>

  <!-- Q7 Event Type -->
  <div class="mb-3">
    <label class="form-label">Event Type <span class="text-danger">*</span></label>
    <select class="form-select" name="event_type" id="event_type" required>
      <option value="">Select…</option>
      <option>Safety Concern</option>
      <option>Injury/Illness</option>
      <option>Property Damage</option>
      <option>Security Concern</option>
      <option>Vehicle Collision</option>
      <option>Environmental</option>
      <option>Depot Event</option>
      <option>Near Miss</option>
    </select>
  </div>

  <!-- Q8–Q9 Severe fields (show only if severe=yes) -->
  <div id="severe_section" class="border rounded p-3 mb-3 d-none">
    <div class="mb-3">
      <label class="form-label">Severe Event Type <span class="text-danger">*</span></label>
      <select class="form-select" name="severe_event_type" id="severe_event_type">
        <option value="">Select…</option>
        <option>AV collision</option>
        <option>Hospitalization or fatality</option>
        <option>Site-wide emergency that requires calling 911</option>
        <option>Physical security or Cybersecurity breach</option>
        <option>Outage longer than 15 minutes</option>
        <option>Chemical spill more than 1 gal</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Severe Event Description <span class="text-danger">*</span></label>
      <textarea class="form-control" name="severe_event_description" rows="3" placeholder="Key details: locations, timings, people/systems involved, actions taken…"></textarea>
    </div>
  </div>

  <!-- Event-type sections (exact wording & order) -->

  <!-- Safety Concern (Q10–Q11) -->
  <div id="sec_safety" class="etype d-none">
    <div class="mb-3">
      <label class="form-label">Safety Concern Description <span class="text-danger">*</span></label>
      <textarea class="form-control" name="safety_description" rows="3" placeholder="What did you see, and where did it happen?"></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">Safety Concern Corrective Action <span class="text-danger">*</span></label>
      <textarea class="form-control" name="safety_corrective_action" rows="2" placeholder="What did you do or suggest to fix it?"></textarea>
    </div>
  </div>

  <!-- Injury/Illness (Q12–Q27) -->
  <div id="sec_injury" class="etype d-none">
    <div class="row">
      <div class="col-md-6 mb-3"><label class="form-label">Injured Employee Name <span class="text-danger">*</span></label><input class="form-control" name="inj_name"></div>
      <div class="col-md-6 mb-3"><label class="form-label">Injured Employee Job Title <span class="text-danger">*</span></label><input class="form-control" name="inj_job_title"></div>
    </div>
    <div class="row">
      <div class="col-md-6 mb-3"><label class="form-label">Injured Employee Phone Number <span class="text-danger">*</span></label><input class="form-control" name="inj_phone" pattern="^\\d[\\d\\s\\-()+]*$"></div>
      <div class="col-md-6 mb-3"><label class="form-label">Injured Employee Address <span class="text-danger">*</span></label><input class="form-control" name="inj_address"></div>
    </div>
    <div class="row">
      <div class="col-md-4 mb-3"><label class="form-label">Injured Employee City <span class="text-danger">*</span></label><input class="form-control" name="inj_city"></div>
      <div class="col-md-4 mb-3"><label class="form-label">Injured Employee State <span class="text-danger">*</span></label><input class="form-control" name="inj_state"></div>
      <div class="col-md-4 mb-3"><label class="form-label">Injured Employee Zip <span class="text-danger">*</span></label><input class="form-control" name="inj_zip" pattern="^\\d{4,10}$"></div>
    </div>
    <div class="mb-3">
      <label class="form-label">Employee Status <span class="text-danger">*</span></label>
      <select class="form-select" name="inj_status">
        <option>Full time</option><option>Part Time</option><option>Temporary</option><option>Contractor</option><option>Visitor</option>
      </select>
    </div>
    <div class="row">
      <div class="col-md-6 mb-3"><label class="form-label">Supervisor Name <span class="text-danger">*</span></label><input class="form-control" name="supervisor_name"></div>
      <div class="col-md-3 mb-3"><label class="form-label">Date Supervisor Was Notified <span class="text-danger">*</span></label><input type="date" class="form-control" name="supervisor_notified_date"></div>
      <div class="col-md-3 mb-3"><label class="form-label">Time Supervisor Was Notified (HHMM) <span class="text-danger">*</span></label><input class="form-control" name="supervisor_notified_time" pattern="^\\d{3,4}$" placeholder="e.g., 1440"></div>
    </div>
    <div class="mb-3"><label class="form-label">Injury/Illness Event Description <span class="text-danger">*</span></label><textarea class="form-control" name="inj_event_description" rows="3"></textarea></div>
    <div class="mb-3">
      <label class="form-label">Injury/Illness Type <span class="text-danger">*</span></label>
      <select class="form-select" name="inj_type">
        <option>Cut, Laceration, or Puncture</option><option>Burn</option><option>Fracture</option><option>Bruise/Contusion</option>
        <option>Sprain or Strain</option><option>Dislocation</option><option>Crush Injury</option><option>Carpal Tunnel Syndrome</option>
        <option>Tendonitis</option><option>Bursitis</option><option>Muscle Strain</option><option>Hearing Loss</option>
        <option>Respiratory Condition</option><option>Skin Disorder</option><option>Heat Stress/Heat Stroke</option>
        <option>Cold Stress - Frostbite/Hypothermia</option><option>Chemical Burn</option><option>Radiation Exposure</option>
        <option>Electrical Shock</option><option>Biological Exposure</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Affected Body Part(s) <span class="text-danger">*</span></label>
      <select class="form-select" multiple name="inj_body_parts">
        <option>Scalp</option><option>Skull</option><option>Eyes</option><option>Ears</option><option>Nose</option><option>Mouth</option><option>Teeth</option>
        <option>Neck</option><option>Shoulders</option><option>Upper Back</option><option>Lower Back</option><option>Upper Arm</option><option>Elbow</option>
        <option>Forearm</option><option>Wrist</option><option>Hand</option><option>Fingers</option><option>Torso</option><option>Chest</option><option>Ribs</option>
        <option>Abdomen</option><option>Pelvis</option><option>Hips</option><option>Thighs</option><option>Knees</option><option>Lower Legs</option>
        <option>Ankles</option><option>Feet</option><option>Toes</option>
      </select>
      <div class="form-text">Hold Ctrl/Cmd to select multiple.</div>
    </div>
    <div class="mb-3"><label class="form-label">Injury/Illness Immediate Action Taken <span class="text-danger">*</span></label><textarea class="form-control" name="inj_immediate_action" rows="2"></textarea></div>
    <div class="mb-3"><label class="form-label">Confirm an Enablon Report was submitted to Waymo via go/waymo-enablon <span class="text-danger">*</span></label>
      <select class="form-select" name="inj_enablon_confirm"><option>Yes - a report has been submitted to Enablon</option></select>
    </div>
  </div>

  <!-- Property Damage (Q28–Q31) -->
  <div id="sec_property" class="etype d-none">
    <div class="mb-3"><label class="form-label">Property Damage Event Description <span class="text-danger">*</span></label><textarea class="form-control" name="prop_description" rows="3"></textarea></div>
    <div class="mb-3"><label class="form-label">Approximate Total Cost of Loss & Repairs (number) <span class="text-danger">*</span></label><input class="form-control" name="prop_cost" pattern="^\\d+(\\.\\d+)?$"></div>
    <div class="mb-3"><label class="form-label">Property Damage Immediate Corrective Action Taken <span class="text-danger">*</span></label><textarea class="form-control" name="prop_corrective_action" rows="2"></textarea></div>
    <div class="mb-3"><label class="form-label">Confirm an Enablon Report was submitted to Waymo via go/waymo-enablon <span class="text-danger">*</span></label><select class="form-select" name="prop_enablon_confirm"><option>Yes - a report has been submitted to Enablon</option></select></div>
  </div>

  <!-- Security Concern (Q32–Q40) -->
  <div id="sec_security" class="etype d-none">
    <div class="mb-3">
      <label class="form-label">Type of Event (check one or more): <span class="text-danger">*</span></label>
      <div class="row row-cols-1 row-cols-md-2">
        {% for t in ["Break-in / Forced Entry","Found Illicit Substance/Paraphernalia or Weapon in ADV","Found Sharps or Medication in ADV","Property Damage","Suspicious Activity","Theft","Trespassing","Vandalism","Workplace Violence / Threat","Other"] %}
        <div class="form-check col mb-1">
          <input class="form-check-input" type="checkbox" name="sec_types" value="{{t}}" id="sec_{{ loop.index }}">
          <label class="form-check-label" for="sec_{{ loop.index }}">{{t}}</label>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="mb-3"><label class="form-label">Security Concern Event Description <span class="text-danger">*</span></label><textarea class="form-control" name="sec_description" rows="3"></textarea></div>
    <div class="mb-3"><label class="form-label">Name(s), job title(s), or description(s) <span class="text-danger">*</span></label><input class="form-control" name="sec_names"></div>
    <div class="mb-3">
      <label class="form-label">Are they: <span class="text-danger">*</span></label>
      <select class="form-select" name="sec_are_they">
        <option>Employee(s)</option><option>Visitor(s)</option><option>Security Staff</option><option>Unknown Individual</option><option>Other</option>
      </select>
    </div>
    <div class="mb-3"><label class="form-label">Was law enforcement or emergency services contacted? <span class="text-danger">*</span></label><select class="form-select" name="sec_law"><option>Yes</option><option>No</option></select></div>
    <div class="mb-3"><label class="form-label">List agency, time called, and any report number or officer name (if known): <span class="text-danger">*</span></label><input class="form-control" name="sec_agency_details"></div>
    <div class="mb-3"><label class="form-label">Is security footage available? <span class="text-danger">*</span></label><select class="form-select" name="sec_footage"><option>Yes</option><option>No</option><option>N/A or Unknown</option></select></div>
    <div class="mb-3"><label class="form-label">Security Concern Corrective Actions Taken <span class="text-danger">*</span></label><textarea class="form-control" name="sec_corrective_action" rows="2" placeholder="e.g., site secured, access restricted, police called…"></textarea></div>
    <div class="mb-3"><label class="form-label">Confirm an Enablon Report was submitted to Waymo via go/waymo-enablon <span class="text-danger">*</span></label><select class="form-select" name="sec_enablon_confirm"><option>Yes - a report has been submitted to Enablon</option></select></div>
  </div>

  <!-- Vehicle Collision (Q41–Q49) -->
  <div id="sec_vehicle" class="etype d-none">
    <div class="mb-3"><label class="form-label">Where did the collision happen? <span class="text-danger">*</span></label><select class="form-select" name="collision_location"><option>AVOMO Parking Lot/Facility</option><option>Public Road / While Traveling for work</option><option>Other</option></select></div>
    <div class="mb-3"><label class="form-label">Involved Parties (Full Names) <span class="text-danger">*</span></label><input class="form-control" name="involved_parties"></div>
    <div class="mb-3"><label class="form-label">Which vehicle was involved? <span class="text-danger">*</span></label><input class="form-control" name="vehicle_identifier" placeholder='e.g., "ABC-123", Employee Van'></div>
    <div class="mb-3"><label class="form-label">What did the Vehicle hit? <span class="text-danger">*</span></label><input class="form-control" name="vehicle_hit" placeholder="e.g., another car, fence"></div>
    <div class="mb-3"><label class="form-label">Was anyone injured? <span class="text-danger">*</span></label><select class="form-select" name="collision_any_injury"><option>Yes</option><option>No</option></select></div>
    <div class="mb-3"><label class="form-label">Was the Vehicle being operated manually or autonomously? <span class="text-danger">*</span></label><select class="form-select" name="collision_mode"><option>Manually</option><option>Autonomously</option><option>Not Sure</option></select></div>
    <div class="mb-3"><label class="form-label">Vehicle Collision Event Description <span class="text-danger">*</span></label><textarea class="form-control" name="collision_description" rows="3"></textarea></div>
    <div class="mb-3"><label class="form-label">Vehicle Collision Immediate Corrective Action Taken <span class="text-danger">*</span></label><textarea class="form-control" name="collision_corrective_action" rows="2"></textarea></div>
    <div class="mb-3"><label class="form-label">Confirm an Enablon Report was submitted to Waymo via go/waymo-enablon <span class="text-danger">*</span></label><select class="form-select" name="collision_enablon_confirm"><option>Yes - a report has been submitted to Enablon</option></select></div>
  </div>

  <!-- Environmental (Q50–Q56) -->
  <div id="sec_environmental" class="etype d-none">
    <div class="mb-3"><label class="form-label">Involved Parties (Full Names) <span class="text-danger">*</span></label><input class="form-control" name="env_involved_parties"></div>
    <div class="mb-3">
      <label class="form-label">Select what is applicable that was involved in the environmental event <span class="text-danger">*</span></label>
      <div class="row row-cols-1 row-cols-md-2">
        {% for r in ["Full time Employees","Part Time Employees","Temporary Employees","Contractor Employees","Visitor","Other"] %}
        <div class="form-check col mb-1">
          <input class="form-check-input" type="checkbox" name="env_roles" value="{{r}}" id="envr_{{ loop.index }}">
          <label class="form-check-label" for="envr_{{ loop.index }}">{{r}}</label>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="mb-3"><label class="form-label">How large was the spill? <span class="text-danger">*</span></label><select class="form-select" name="spill_volume"><option>Less than one (1) gallon</option><option>More than one (1) gallon</option><option>Unknown</option></select></div>
    <div class="mb-3"><label class="form-label">What chemical(s) was involved in the spill? <span class="text-danger">*</span></label><input class="form-control" name="chemicals"></div>
    <div class="mb-3"><label class="form-label">Environmental Spill Event Description <span class="text-danger">*</span></label><textarea class="form-control" name="env_description" rows="3"></textarea></div>
    <div class="mb-3"><label class="form-label">Environmental Spill Immediate Corrective Action <span class="text-danger">*</span></label><textarea class="form-control" name="env_corrective_action" rows="2"></textarea></div>
    <div class="mb-3"><label class="form-label">Confirm an Enablon Report was submitted to Waymo via go/waymo-enablon <span class="text-danger">*</span></label><select class="form-select" name="env_enablon_confirm"><option>Yes - a report has been submitted to Enablon</option></select></div>
  </div>

  <!-- Depot Event (Q57–Q59) -->
  <div id="sec_depot" class="etype d-none">
    <div class="mb-3"><label class="form-label">Event Description <span class="text-danger">*</span></label><textarea class="form-control" name="depot_description" rows="3" placeholder="What happened?"></textarea></div>
    <div class="mb-3"><label class="form-label">Immediate Actions Taken <span class="text-danger">*</span></label><textarea class="form-control" name="depot_actions" rows="2" placeholder="Describe the actions that were taken"></textarea></div>
    <div class="mb-3"><label class="form-label">Outcome & Lessons Learned <span class="text-danger">*</span></label><textarea class="form-control" name="depot_outcome" rows="2" placeholder="Outcome / what you learned / what you’d do differently"></textarea></div>
  </div>

  <!-- Near Miss (Q60–Q62) -->
  <div id="sec_near_miss" class="etype d-none">
    <div class="mb-3">
      <label class="form-label">Near Miss Type <span class="text-danger">*</span></label>
      <div class="d-flex gap-3 flex-wrap">
        {% for t in ["Potential Injury","Potential Property Damage","Potential Environmental Damage","Potential Damage to Company Image"] %}
        <div class="form-check">
          <input class="form-check-input" type="radio" name="near_type" value="{{t}}" id="neart_{{ loop.index }}" required>
          <label class="form-check-label" for="neart_{{ loop.index }}">{{t}}</label>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="mb-3"><label class="form-label">Near Miss Description <span class="text-danger">*</span></label><textarea class="form-control" name="near_description" rows="3" placeholder="What did you see, and where did it happen?"></textarea></div>
    <div class="mb-3"><label class="form-label">Near Miss Corrective Action <span class="text-danger">*</span></label><textarea class="form-control" name="near_corrective_action" rows="2" placeholder="What did you do or suggest to fix it?"></textarea></div>
  </div>

  <!-- Root Cause & Corrective Actions (Q63–Q71) -->
  <div class="border rounded p-3 mb-3">
    <h5 class="mb-3">Root Cause Analysis (5 Whys)</h5>
    <div class="row">
      <div class="col-md-6 mb-3"><label class="form-label">First Why? <span class="text-danger">*</span></label><input class="form-control" name="why1"></div>
      <div class="col-md-6 mb-3"><label class="form-label">Second Why? <span class="text-danger">*</span></label><input class="form-control" name="why2"></div>
      <div class="col-md-6 mb-3"><label class="form-label">Third Why? <span class="text-danger">*</span></label><input class="form-control" name="why3"></div>
      <div class="col-md-6 mb-3"><label class="form-label">Fourth Why? <span class="text-danger">*</span></label><input class="form-control" name="why4"></div>
      <div class="col-md-6 mb-3"><label class="form-label">Fifth Why? <span class="text-danger">*</span></label><input class="form-control" name="why5"></div>
    </div>
    <div class="row">
      <div class="col-md-6 mb-3"><label class="form-label">Corrective Action <span class="text-danger">*</span></label><input class="form-control" name="capa_action"></div>
      <div class="col-md-6 mb-3"><label class="form-label">Action Owner Name <span class="text-danger">*</span></label><input class="form-control" name="capa_owner"></div>
      <div class="col-md-6 mb-3"><label class="form-label">Action Owner E-mail <span class="text-danger">*</span></label><input type="email" class="form-control" name="capa_owner_email"></div>
      <div class="col-md-6 mb-3"><label class="form-label">Due Date <span class="text-danger">*</span></label><input type="date" class="form-control" name="capa_due"></div>
    </div>
  </div>

  <button class="btn btn-primary">Create Incident</button>
</form>

<script>
(function(){
  const eventTypeEl = document.getElementById('event_type');
  const severeEl = document.getElementById('severe_event_flag');
  const severeSection = document.getElementById('severe_section');

  function showSection(id) {
    document.querySelectorAll('.etype').forEach(x => x.classList.add('d-none'));
    if (!id) return;
    const el = document.getElementById(id);
    if (el) el.classList.remove('d-none');
  }
  function onTypeChange(){
    const v = (eventTypeEl.value || '').toLowerCase();
    const map = {
      'safety concern':'sec_safety',
      'injury/illness':'sec_injury',
      'property damage':'sec_property',
      'security concern':'sec_security',
      'vehicle collision':'sec_vehicle',
      'environmental':'sec_environmental',
      'depot event':'sec_depot',
      'near miss':'sec_near_miss'
    };
    showSection(map[v]);
  }
  function onSevereChange(){
    const yes = (severeEl.value === 'yes');
    severeSection.classList.toggle('d-none', !yes);
    ['severe_event_type','severe_event_description'].forEach(n=>{
      const el = document.getElementsByName(n)[0];
      if (!el) return;
      if (yes) el.setAttribute('required','required'); else { el.removeAttribute('required'); el.value=''; }
    });
  }

  eventTypeEl.addEventListener('change', onTypeChange);
  severeEl.addEventListener('change', onSevereChange);
  window.addEventListener('DOMContentLoaded', ()=>{ onTypeChange(); onSevereChange(); });
})();
</script>
{% endblock %}
