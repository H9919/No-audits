<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>YZ-AI Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --primary:#2563eb;--secondary:#64748b;--success:#10b981;--danger:#ef4444
    }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;background:#f8fafc;overflow:hidden}
    .app{display:flex;height:100%}
    .sidebar{width:280px;background:linear-gradient(180deg,#1e293b 0%,#334155 100%);color:#cbd5e1;display:flex;flex-direction:column}
    .sidebar h4{color:#fff}
    .nav-item{display:block;color:#cbd5e1;text-decoration:none;padding:.75rem 1rem;border-left:3px solid transparent}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.08);border-left-color:var(--primary)}
    .nav-item.active{color:#fff;background:rgba(37,99,235,.18);border-left-color:var(--primary)}
    .chat{flex:1;display:flex;flex-direction:column;background:#fff}
    .chat-header{padding:1rem 1.5rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .chat-messages{flex:1;overflow:auto;background:#f9fafb;padding:1.25rem}
    .message{margin-bottom:1rem;animation:fadeIn .2s ease}
    .message .hdr{display:flex;align-items:center;gap:.5rem;margin-bottom:.25rem}
    .avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.8rem}
    .avatar.user{background:linear-gradient(135deg,var(--success),#059669)}
    .avatar.ai{background:linear-gradient(135deg,var(--primary),#3b82f6)}
    .time{margin-left:auto;color:#9ca3af;font-size:.75rem}
    .content{margin-left:2.1rem;line-height:1.55;color:#374151}
    .chat-input{padding:1rem 1.25rem;border-top:1px solid #e5e7eb;background:#fff}
    .input-wrap{display:flex;gap:.5rem;align-items:flex-end;max-width:1000px;margin:0 auto}
    .field{flex:1;border:2px solid #e5e7eb;border-radius:1rem;min-height:56px;max-height:180px;resize:none;padding:.75rem 1rem}
    .field:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
    .icon-btn,.send-btn{width:48px;height:48px;border-radius:.75rem;border:0;display:flex;align-items:center;justify-content:center;color:#fff}
    .icon-btn{background:var(--secondary)}
    .icon-btn:hover{background:#475569}
    .send-btn{background:var(--primary)}
    .send-btn:hover{background:#1d4ed8}
    .send-btn:disabled{background:#9ca3af}
    .file-input{display:none}
    .quick{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;max-width:900px;margin:2rem auto}
    .card.quick-card{cursor:pointer;border:1px solid #e5e7eb}
    .card.quick-card:hover{transform:translateY(-2px);box-shadow:0 .5rem 1rem rgba(0,0,0,.08)}
    .stat{padding:1rem;border-top:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.18)}
    .stat .rowx{display:flex;justify-content:space-between;padding:.35rem 0}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @media(max-width:768px){.sidebar{position:absolute;inset:0 auto 0 0;transform:translateX(-100%);transition:.25s}.sidebar.open{transform:none}}
  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="p-3 border-bottom border-white border-opacity-10">
      <h4 class="m-0"><i class="bi bi-robot me-2"></i>YZ-AI</h4>
    </div>
    <div class="p-2 small text-uppercase text-white-50">Dashboard</div>
    <a class="nav-item active" href="/"><i class="bi bi-robot me-2"></i>AI Assistant</a>
    <a class="nav-item" href="/dashboard"><i class="bi bi-graph-up me-2"></i>Analytics</a>

    <div class="p-2 small text-uppercase text-white-50 mt-2">Safety Management</div>
    <a class="nav-item" href="/incidents"><i class="bi bi-exclamation-triangle me-2"></i>Incidents</a>
    <a class="nav-item" href="/safety-concerns"><i class="bi bi-shield-exclamation me-2"></i>Safety Concerns</a>
    <a class="nav-item" href="/risk/register"><i class="bi bi-graph-up-arrow me-2"></i>Risk Register</a>

    <div class="p-2 small text-uppercase text-white-50 mt-2">Operations</div>
    <a class="nav-item" href="/capa"><i class="bi bi-arrow-repeat me-2"></i>CAPAs</a><a class="nav-item" href="/sds"><i class="bi bi-file-earmark-text me-2"></i>SDS Library</a><div class="stat mt-auto">
      <div class="rowx"><span>Open Incidents</span><b id="openIncidents">0</b></div>
      <div class="rowx"><span>Overdue CAPAs</span><b id="overdueCapas">0</b></div>
      <div class="rowx"><span>Safety Concerns</span><b id="safetyConcerns">0</b></div>
      <div class="rowx"><span>System Status</span><b class="text-success" id="sysStatus">Online</b></div>
    </div>

    <!-- Small CAPA tracker (optional) -->
    <div class="p-3 border-top border-white border-opacity-10">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="small text-white-50">CAPA Tracker</span>
        <div class="d-flex gap-2 align-items-center">
          <select id="capaFilterStatus" class="form-select form-select-sm" style="width:auto">
            <option value="">All</option><option value="open">Open</option>
            <option value="in_progress">In Progress</option><option value="completed">Completed</option>
          </select>
          <button class="btn btn-sm btn-outline-light" onclick="loadCapas()">Apply</button>
        </div>
      </div>
      <div id="capaList" class="list-group small"></div>
    </div>
  </aside>

  <!-- Chat -->
  <main class="chat">
    <div class="chat-header">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-light d-md-none" id="menuBtn"><i class="bi bi-list"></i></button>
        <div>
          <div class="fw-semibold">YZ-AI Assistant</div>
          <div class="text-muted small">Your intelligent AI companion</div>
        </div>
      </div>
      <span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size:.5rem"></i>Online</span>
    </div>

    <div class="chat-messages" id="chat">
      <!-- Welcome / Quick actions -->
      <section id="welcome" class="container">
        <div class="text-center my-4">
          <div class="mx-auto mb-3" style="width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#3b82f6);display:flex;align-items:center;justify-content:center;color:#fff;font-size:2rem">
            <i class="bi bi-robot"></i>
          </div>
          <h2 class="h4">Welcome to YZ-AI</h2>
          <p class="text-muted">Report incidents, assess risks, manage CAPAs, find SDS‚Äîand more. What would you like to do?</p>
        </div>
        <div class="quick">
          <div class="card quick-card" onclick="sendMessage('I need to report a workplace incident')">
            <div class="card-body d-flex gap-2 align-items-start"><div>üö®</div>
              <div><b>Report an Incident</b><div class="text-muted small">Guided incident capture</div></div></div>
          </div>
          <div class="card quick-card" onclick="sendMessage('I want to submit a safety concern')">
            <div class="card-body d-flex gap-2 align-items-start"><div>üõ°Ô∏è</div>
              <div><b>Safety Concern</b><div class="text-muted small">Near miss / unsafe act</div></div></div>
          </div>
          <div class="card quick-card" onclick="sendMessage('Help me conduct a risk assessment')">
            <div class="card-body d-flex gap-2 align-items-start"><div>üìä</div>
              <div><b>Risk Assessment</b><div class="text-muted small">ERC/likelihood matrix</div></div></div>
          </div>
          <div class="card quick-card" onclick="sendMessage('I need to find a safety data sheet')">
            <div class="card-body d-flex gap-2 align-items-start"><div>üìã</div>
              <div><b>Find SDS</b><div class="text-muted small">Search & cite pages</div></div></div>
          </div>
          <div class="card quick-card" onclick="sendMessage('Show me what needs my attention today')">
            <div class="card-body d-flex gap-2 align-items-start"><div>‚ö°</div>
              <div><b>What's Urgent?</b><div class="text-muted small">Overdue & priority</div></div></div>
          </div>
          <div class="card quick-card" onclick="sendMessage('Help me get started with the AI system')">
            <div class="card-body d-flex gap-2 align-items-start"><div>üéØ</div>
              <div><b>System Tour</b><div class="text-muted small">Feature walkthrough</div></div></div>
          </div>
        </div>
      </section>
    </div>

    <!-- Input -->
    <div class="chat-input">
      <form id="chatForm" onsubmit="return false;">
        <div class="input-wrap">
          <textarea id="msg" class="field" rows="1" placeholder="Ask me anything about EHS‚Ä¶ (e.g. 'Report incident', 'Find SDS acetone')"></textarea>
          <button class="icon-btn" type="button" id="fileBtn" title="Attach file"><i class="bi bi-paperclip"></i></button>
          <button class="btn btn-outline-secondary" type="button" id="fiveBtn" title="Start 5 Whys">5 Whys</button>
          <button class="btn btn-outline-secondary" type="button" id="capaBtn" title="Suggest CAPA">CAPA</button>
          <button class="send-btn" type="submit" id="sendBtn" title="Send"><i class="bi bi-send"></i></button>
          <input id="file" class="file-input" type="file" accept="image/*,.pdf,.txt">
        </div>
      </form>
      <div id="filePreview" class="form-text ms-2 mt-1 d-none"></div>
    </div>
  </main>
</div>

<script>
  // ---- State
  let historyBuf = [];
  let waiting = false;
  let selFile = null;
  let fiveActive = false;

  // ---- Helpers (DOM)
  const $ = (s)=>document.querySelector(s);
  const chat = $('#chat');
  const msg = $('#msg');
  const file = $('#file');
  const fileBtn = $('#fileBtn');
  const sendBtn = $('#sendBtn');
  const fiveBtn = $('#fiveBtn');
  const capaBtn = $('#capaBtn');
  const menuBtn = $('#menuBtn');

  function timeNow(){ return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

  function addMessage(who, text){
    const wrap = document.createElement('div');
    wrap.className='message';
    wrap.innerHTML = `
      <div class="hdr">
        <div class="avatar ${who==='user'?'user':'ai'}">${who==='user'?'You':'AI'}</div>
        <div class="fw-semibold">${who==='user'?'You':'YZ-AI Assistant'}</div>
        <div class="time">${timeNow()}</div>
      </div>
      <div class="content">${formatHtml(text||'')}</div>`;
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  function formatHtml(s){
    const esc = (t)=>t.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const e = esc(String(s));
    return e.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
            .replace(/\*(.*?)\*/g,'<em>$1</em>')
            .replace(/`([^`]+)`/g,'<code>$1</code>')
            .replace(/\n/g,'<br>');
  }

  function setEnabled(b){
    waiting = !b;
    sendBtn.disabled = !b;
    msg.disabled = !b;
    if(b) msg.focus();
  }

  function showFilePreview(){
    const p = $('#filePreview');
    if(!selFile){ p.classList.add('d-none'); p.textContent=''; return; }
    p.textContent = `Attached: ${selFile.name} (${Math.ceil(selFile.size/1024)} KB)`;
    p.classList.remove('d-none');
  }

  // ---- Intent normalizer (maps common phrasings to backend-friendly triggers)
  function normalizeIntent(text){
    const t = (text||'').trim().toLowerCase();
    if (/^help( with (this )?page)?$/.test(t) || /help.*page/.test(t)) return "Help with this page";
    if (/report( an)? incident|start.*incident|incident report/.test(t)) return "Report incident";
    if (/safety concern|near miss|unsafe/.test(t)) return "Safety concern";
    if (/find sds|sds|safety data sheet/.test(t)) return "Find SDS";
    if (/risk assessment|erc|likelihood/.test(t)) return "Risk assessment";
    if (/urgent|priority|overdue/.test(t)) return "What's urgent?";
    if (/tour|getting started|guide|onboard/.test(t)) return "Help with this page";
    return text;
  }

  // ---- API calls
  async function postChat(bodyFd){
    const res = await fetch('/chat', {method:'POST', body: bodyFd});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }
  async function postFiveStart(problem){
    const fd = new FormData();
    fd.append('problem', problem);
    fd.append('user_id', 'main_chat_user');
    const r = await fetch('/chat/five_whys/start', {method:'POST', body:fd});
    return await r.json();
  }
  async function postFiveAnswer(ans, complete=false){
    const fd = new FormData();
    fd.append('answer', ans);
    fd.append('user_id', 'main_chat_user');
    if(complete) fd.append('complete','true');
    const r = await fetch('/chat/five_whys/answer', {method:'POST', body:fd});
    return await r.json();
  }
  async function postCapaSuggest(desc){
    const fd = new FormData();
    fd.append('description', desc);
    const r = await fetch('/chat/capa/suggest', {method:'POST', body:fd});
    return await r.json();
  }

  // ---- Main send wrapper (used by quick-action cards)
  function sendMessage(text){
    msg.value = normalizeIntent(text || '');
    sendBtn.click();
  }

  // ---- Events
  document.addEventListener('DOMContentLoaded', () => {
    // greet
    addMessage('ai',"üëã Hello! I'm your YZ-AI Assistant. How can I help?");
    // stats & CAPA list
    refreshStats(); loadCapas();
    setInterval(refreshStats, 30000);

    // bindings
    msg.addEventListener('input', ()=>{ msg.style.height='auto'; msg.style.height=Math.min(msg.scrollHeight,180)+'px'; });
    msg.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});
    $('#chatForm').addEventListener('submit', onSend);
    fileBtn.addEventListener('click', ()=>file.click());
    file.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(validateFile(f)){ selFile=f; showFilePreview(); } else { file.value=''; selFile=null; showFilePreview(); }});
    fiveBtn.addEventListener('click', onStartFive);
    capaBtn.addEventListener('click', onCapa);
    if(menuBtn) menuBtn.addEventListener('click', ()=>$('#sidebar').classList.toggle('open'));
  });

  async function onSend(e){
    e.preventDefault();
    if(waiting) return;

    const raw = (msg.value||'').trim();
    const text = normalizeIntent(raw);

    if(!text && !selFile) return;

    // 5-Whys active ‚Üí treat this as an answer
    if(fiveActive && text){
      addMessage('user', text);
      setEnabled(false);
      try{
        const data = await postFiveAnswer(text,false);
        if(data.ok && data.complete){
          fiveActive=false;
          const lines = (data.whys||[]).map((wa,i)=>`Why ${i+1}: ${wa.a}`).join('\n');
          addMessage('ai',`5 Whys completed.\n${lines}`);
        }else if(data.ok){
          addMessage('ai', data.prompt||'Next why?');
        }else{
          addMessage('ai', data.error||'Error in 5 Whys.');
        }
      }catch(err){ addMessage('ai',"I'm having trouble connecting right now."); }
      setEnabled(true);
      msg.value=''; selFile=null; file.value=''; showFilePreview();
      return;
    }

    // Normal chat
    addMessage('user', text || `üìé ${selFile?.name||'file'}`);
    setEnabled(false);

    const fd = new FormData();
    if(text) fd.append('message', text);
    fd.append('user_id','main_chat_user');
    fd.append('context', JSON.stringify({from:'dashboard', ts: Date.now(), last: historyBuf.slice(-6)}));
    if(selFile) fd.append('file', selFile);

    try{
      const data = await postChat(fd);
      addMessage('ai', data.message || 'OK');
      historyBuf.push({u:text,a:data.message});
      if(historyBuf.length>50) historyBuf = historyBuf.slice(-25);
    }catch(err){
      addMessage('ai',"I'm sorry, I'm having trouble connecting right now.");
      console.error(err);
    }
    setEnabled(true);
    msg.value=''; selFile=null; file.value=''; showFilePreview();
  }

  async function onStartFive(){
    const problem = (msg.value||'').trim();
    if(!problem){ toast('Type the problem first.','warning'); return; }
    try{
      const data = await postFiveStart(problem);
      if(data.ok){
        fiveActive=true;
        addMessage('user', problem);
        addMessage('ai', data.prompt || 'Why did it happen?');
        msg.value='';
      }else{
        toast(data.error || 'Cannot start 5 Whys','danger');
      }
    }catch(err){ toast('Error starting 5 Whys','danger'); }
  }

  async function onCapa(){
    const desc = (msg.value||'').trim();
    if(!desc){ toast('Type a short description first.','warning'); return; }
    try{
      const data = await postCapaSuggest(desc);
      if(data.ok){
        const actions = (data.actions||[]).map((a,i)=>`${i+1}. ${a}`).join('\n');
        addMessage('ai', `Suggested CAPAs (conf ${data.confidence} via ${data.rationale||'hybrid'}):\n${actions}`);
        msg.value='';
      }else{
        toast(data.error || 'Failed to suggest CAPA','danger');
      }
    }catch(err){ toast('Error suggesting CAPA','danger'); }
  }

  // ---- Validators
  function validateFile(f){
    if(!f) return false;
    if(f.size > 16*1024*1024){ toast('File too large (max 16MB).','danger'); return false; }
    const ok = ['image/jpeg','image/png','image/gif','image/webp','application/pdf','text/plain'];
    if(!ok.includes(f.type)){ toast('Unsupported file type. Use images, PDF, or TXT.','danger'); return false; }
    return true;
  }

  // ---- Stats + CAPA list
  async function refreshStats(){
    try{
      const r = await fetch('/api/stats'); if(!r.ok) throw 0;
      const d = await r.json();
      $('#openIncidents').textContent = d.incidents?.open ?? 0;
      $('#overdueCapas').textContent  = d.capas?.overdue ?? 0;
      $('#safetyConcerns').textContent= d.safety_concerns?.open ?? 0;
      $('#sysStatus').textContent = 'Online'; $('#sysStatus').classList.remove('text-danger'); $('#sysStatus').classList.add('text-success');
    }catch{
      $('#sysStatus').textContent = 'Offline'; $('#sysStatus').classList.remove('text-success'); $('#sysStatus').classList.add('text-danger');
    }
  }
  async function loadCapas(){
    try{
      const st = $('#capaFilterStatus').value;
      const url = st ? `/capa/api/list?status=${encodeURIComponent(st)}` : '/capa/api/list';
      const r = await fetch(url); if(!r.ok) throw 0;
      const data = await r.json();
      const el = $('#capaList'); el.innerHTML='';
      (data.items||[]).slice(0,8).forEach(c=>{
        const badge = c.status==='completed'?'success':(c.status==='in_progress'?'warning':'secondary');
        const overdue = c.overdue ? `<span class="badge bg-danger ms-1">Overdue ${c.days_overdue||0}d</span>` : '';
        const a = document.createElement('a');
        a.href = `/capa/${c.id}`;
        a.className='list-group-item list-group-item-action d-flex justify-content-between align-items-start';
        a.innerHTML = `<div><div class="fw-semibold">${c.title||'CAPA'}</div>
          <div class="small text-white-50">${c.source||''} ${c.source_id?('#'+c.source_id):''} ${c.due_date?('¬∑ due '+c.due_date):''}</div></div>
          <div><span class="badge bg-${badge}">${(c.status||'open').replace('_',' ')}</span>${overdue}</div>`;
        el.appendChild(a);
      });
    }catch(e){ /* silent */ }
  }

  // ---- Reset (UI + server)
  async function resetChat(){
    historyBuf=[]; fiveActive=false; selFile=null; msg.value=''; file.value=''; $('#filePreview').classList.add('d-none');
    chat.innerHTML=''; document.title='YZ-AI Assistant';
    // show welcome again
    const w = document.getElementById('welcome'); if (w) w.style.display='block';
    addMessage('ai',"üëã Hello! I'm your YZ-AI Assistant. How can I help?");
    try{ await fetch('/chat/reset',{method:'POST'}); }catch{}
  }

  // ---- Toast
  function toast(text, type='info'){
    const el = document.createElement('div');
    el.className = `alert alert-${type} position-fixed`;
    el.style.cssText='right:20px;top:20px;z-index:9999;min-width:260px';
    el.innerText = text;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 3000);
  }
</script>
</body>
</html>
